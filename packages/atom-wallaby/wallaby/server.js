/*
 * Wallaby.js - v1.0.279
 * http://wallabyjs.com
 * Copyright (c) 2014-2016 Wallaby.js - All Rights Reserved.
 *
 * This source code file is a part of Wallaby.js and is a proprietary (closed source) software.

 * IMPORTANT:
 * Wallaby.js is a tool made by software developers for software developers with passion and love for what we do.
 * Pirating the tool is not only illegal and just morally wrong,
 * it is also unfair to other fellow programmers who are using it legally,
 * and very harmful for the tool and its future.
 */
!function e(t,i,n){function s(a,o){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!o&&l)return l(a,!0);if(r)return r(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var c=i[a]={exports:{}};t[a][0].call(c.exports,function(e){var i=t[a][1][e];return s(i?i:e)},c,c.exports,e,t,i,n)}return i[a].exports}for(var r="function"==typeof require&&require,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(e,t,i){e("./global"),process.on("uncaughtException",function(e){e&&"spawn"===e.syscall&&"OK"===e.code||(e&&e.message&&_.isString(e.message)&&0===e.message.indexOf("payload cannot exceed")&&(e.stack="One of the files specified in your `files`/`tests` list is too large, "+e.stack),console.error(e instanceof Error?e.stack:util.inspect(e)))}),t.exports={start:function(t){t.onConnected=function(i){t.Project=e("./project"),t.diffMatchPatch=new(e("./diffMatchPatch"));var n=new t.Receiver(t),s=process.exit,r=function(){n.stop(),console.log("wallaby.js stopped"),s.apply(process,arguments)},a=process.exit=function(){r.apply(null,arguments)};return process.on("SIGINT",function(){a.apply(null,arguments)}),n.on("message",function(e){!e._internal&&i.send(e)}),i.receive=function(e){var t="unknown";try{if(t=e.type,!("string"==typeof t&&t.length>0&&"_"!==t[0]))throw new Error("Incorrect incoming message format");var i=n[t](e);i&&i.fail&&i.fail(function(e){e.noDetails?console.error(e.message):console.error("Failed to execute "+t+" operation, "+e.stack)})}catch(s){console.error("Failed to start "+t+" operation, "+s.stack)}},n.configure(),n}}}},{"./diffMatchPatch":6,"./global":9,"./project":17}],2:[function(e,t,i){"use strict";var n,s,r=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=e("path"),l=e("semver"),u="5.0.9",c=function(){function e(t,i){a(this,e);var n=this;_.isEmpty(t)||t.babelrc||(t.babelrc=!1),this._opts=_.extend({filename:i},t||{}),!this._opts.filename&&i&&(this._opts.filename=i),this._opts.filenameRelative||delete this._opts.filenameRelative,this._opts.sourceMaps=this._opts.sourceMap=!0,this._opts.comments||(this._opts.comments=!1),_.isString(this._opts.plugins)&&(this._opts.plugins=[this._opts.plugins]),this._opts.plugins=(this._opts.plugins||[]).slice(),this._opts.plugins.unshift(new s("wallaby.js",{Statement:function(e){switch(e.type){case"DoWhileStatement":case"WhileStatement":case"IfStatement":case"ForStatement":e.test&&n._pushRange(e.test.loc);break;case"ForOfStatement":case"ForInStatement":e.right&&n._pushRange(e.right.loc);break;case"SwitchStatement":n._pushRange(e.discriminant.loc);break;case"BreakStatement":case"ContinueStatement":case"ThrowStatement":case"VariableDeclaration":case"ExpressionStatement":case"ReturnStatement":n._pushRange(e.loc)}},ArrowFunctionExpression:function(e){e.expression&&n._pushRange(e.body.loc)},LogicalExpression:function(e){n._pushRange(e.left.loc),n._pushRange(e.right.loc)},ConditionalExpression:function(e){n._pushRange(e.consequent.loc),n._pushRange(e.alternate.loc)}}))}return r(e,{_pushRange:{value:function(e){e&&this._ranges.push([e.start.line,e.start.column,e.end.line,e.end.column])}},run:{value:function(e){this._ranges=[];var t=n.transform(e.content,this._opts);return{map:t.map,code:t.code,ranges:this._ranges}}}}),e}();t.exports=function(t){return function(i){if(i=i||{},i.babel)n=i.babel;else try{n=e(o.join(t,"node_modules","babel-core"))}catch(r){try{n=e(o.join(t,"node_modules","babel"))}catch(a){throw new Error("babel or babel-core must be installed locally or babel instance must be passed in opts.babel, for example `wallaby.compilers.babel({ babel: require('babel') })`")}}return l.valid(n.version)&&l.lt(n.version,u)?void console.error("Babel version for compiler must be >= "+u):(s=n.Transformer||function(e,t){return _.each(t,function(e,i){t[i]=function(t){return e(t.node)}}),{visitor:t}},delete i.babel,function(e){return new c(i,e.path).run(e)})}}},{path:void 0,semver:void 0}],3:[function(e,t,i){var n,s=e("path"),r=e("graceful-fs"),a=e("express"),o=r.readFileSync(s.join(__dirname,"runners","browser","sandbox.html")).toString(),l="__wallaby__",u=e("./fileCacheMiddleware"),c=function(t,i){var r=this;n=e("debug")("wallaby:browserRunner"),r._project=t,r._workerPool=i,r._baseDir=r._project._instrumentedRoot+s.sep,r._initializer=t.settings().bootstrap,r._sandboxHtml={},r._report404AsError=t.settings().env.report404AsError,r._lruCache=r._project._lruCache,r._wallabyFileIdPrefix=r._workerPool.wallabyFileIdPrefix(),r._app=a(),r._app.use("/wallaby_sandbox:id.html",function(e,t){t.send(r._sandboxHtml[e.params.id])}),t.settings().testFramework.path&&r._app.use("/"+l+"/"+t.settings().testFramework.version+"/framework.js",u.create(s.join(t._localRoot,t.settings().testFramework.path))),r._app.use("/"+l+"/tracer.js",u.create(s.join(__dirname,"tracer.js"))),r._app.use("/"+l,u.create(s.join(__dirname,"runners","browser"))),t.settings().middleware(r._app,a),r._app.use(u.create(r._baseDir,r._lruCache,r._report404AsError))};c.prototype={prepareSandbox:function(e,t,i){var s=this;e.allFilesHash=_.reduce(e.allFiles.concat(e.allTestFiles),function(e,t){return e[t.normalizedRelativePath]={ts:t.ts,id:t.tmp&&t.originalId?t.originalId:t.id},e},{});var r=e.allFiles.concat(e.allTestFiles),a=e.filesToLoad.concat(e.testFilesToLoad),u=_.reduce(e.testFilesToLoad,function(e,t){return e[t.id]=t,e},{});n("Total files to load in sandbox: "+a.length);var c=s._workerPool.receiverPort();s._sandboxHtml[i]=o.replace("<inject/>",function(){return _.reduce(r,function(e,t){return e+(_.isNumber(t.id)?"file = window.$_$coverage["+t.id+"]=[]; for(i=0, len="+t.rangesLength+"; i < len; i++) file[i] = {};":"")},"<script>(function() {window.$_$receiverPort = "+c+';window.$_$session="'+t+'";window.$_$baseDir='+JSON.stringify(s._baseDir)+";window.$_$initialSpecId="+1e5*(i+1)+";window.$_$coverage=[]; var file, i, len;")+"window.$_$slow="+s._project.settings().slowTestThreshold+";window.$_$files="+JSON.stringify(e.allFilesHash)+";window.$_$tests="+(e.tests?JSON.stringify(e.tests):"null")+";window.$_$testFiles="+JSON.stringify(_.chain(e.allTestFiles).filter(function(e){return!e.shadowed}).map(function(t){return{path:t.relativePath,loaded:t.include&&!!u[t.id],id:(e.allFilesHash[t.normalizedRelativePath]||{}).id}}).value())+';})();</script><script src="'+l+'/tracer.js"></script><script src="'+l+"/"+e.framework.version+'/framework.js"></script><script src="'+l+"/"+e.framework.configurator+'/configurator.js"></script><script src="'+l+"/"+e.framework.reporter+'/reporter.js"></script>'+_.reduce(a,function(e,t){var i=t.tmp,r=t.ts+(i?t.originalId?s._wallabyFileIdPrefix+t.originalId:"":s._wallabyFileIdPrefix+t.id);switch(t.type){case"js":case"jsx":case"es6":return e+'<script src="'+t.normalizedRelativePath+"?"+r+'"></script>';case"html":case"htm":return e+'<link href="'+t.normalizedRelativePath+"?"+t.ts+'" rel="import">';case"css":return e+'<link rel="stylesheet" type="text/css" href="'+t.normalizedRelativePath+"?"+r+'"></link>';default:return n("File type "+t.type+" can not be included via script/link tag into sandbox"),e}},"")+(s._initializer?"<script>("+s._initializer+")(window.wallaby);</script>":"")+'<script src="'+l+"/"+e.framework.starter+'/starter.js"></script>'});var h=s.sandboxRootUrl()+"wallaby_sandbox"+i+".html";return n("Sandbox is generated [%s]: %s",s.sandboxName(i,t),h),Q.when(h)},sandboxRootUrl:function(){return this._sandboxRootUrl?this._sandboxRootUrl:(this._sandboxRootUrl="http://localhost:"+this._workerPool.receiverPort()+"/",this._sandboxRootUrl)},webApp:function(){return this._app},sandboxName:function(e,t){return"worker #"+e+", session #"+t}},t.exports=c},{"./fileCacheMiddleware":8,debug:void 0,express:void 0,"graceful-fs":void 0,path:void 0}],4:[function(e,t,i){"use strict";var n,s,r,a=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},l=e("path"),u={},c={},h=function(){function e(t){o(this,e);var i=this;this._opts=_.extend({},t||{}),this._noRename=this._opts.noFileRename,delete this._opts.noFileRename,this._nodeVisitor("Block",function(e){_.each(e.expressions,function(e){e.expression?i._pushRange(e.expression):i._pushRange(e)})}),this._nodeVisitor("Op",function(e){("&&"===e.operator||"||"===e.operator||"?"===e.operator)&&(i._pushRange(e.first),i._pushRange(e.second))})}return a(e,{_nodeVisitor:{value:function(e,t){if(c[e]=t,!u[e]){var i=n[e].prototype.compileNode;n[e].prototype.compileNode=function(){return c[e](this),i.apply(this,arguments)},u[e]=!0}}},_pushRange:{value:function(e){if(e){var t=e.locationData;t?this._ranges.push([t.first_line+1,t.first_column,t.last_line+1,t.last_column+1]):e.args&&e.args.length&&this._pushRange(e.args[0])}}},run:{value:function(e){this._ranges=[];var t=s.compile(e.content,_.extend({},this._opts,{filename:e.path,sourceMap:!0,literate:r.isLiterate(e.path)}));return this._noRename||e.changeExt("js"),{map:t.v3SourceMap,code:t.js,ranges:this._ranges}}}}),e}();t.exports=function(t){try{n=e(l.join(t,"node_modules","coffee-script","lib","coffee-script","nodes")),s=e(l.join(t,"node_modules","coffee-script"))}catch(i){n=e("coffee-script/lib/coffee-script/nodes"),s=e("coffee-script")}return r=s.helpers,function(e){return function(t){return new h(e).run(t)}}}},{"coffee-script":void 0,"coffee-script/lib/coffee-script/nodes":void 0,path:void 0}],5:[function(e,t,i){"use strict";var n,s=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=e("path"),o={node:{"mocha@2.1.0":{},"jest@0.4.3":{},"jasmine@2.3.4":{},"ava@0.3.0":{jsPreprocessor:function(e){return e.replace(/import test from ["|']ava["|']/,'var test = require("ava")')}},"tape@4.2.2":{jsPreprocessor:function(e){return e.replace(/import test from ["|']tape["|']/,'var test = require("tape")')}}},browser:{"jasmine@1.3.1":{},"jasmine@2.1.3":{},"jasmine@2.2.1":{configurator:"jasmine@2.1.3",reporter:"jasmine@2.1.3",starter:"jasmine@2.1.3"},"jasmine@2.3.4":{configurator:"jasmine@2.1.3",reporter:"jasmine@2.1.3",starter:"jasmine@2.1.3"},"jasmine@2.4.1":{configurator:"jasmine@2.1.3",reporter:"jasmine@2.1.3",starter:"jasmine@2.1.3"},"mocha@2.0.1":{},"mocha@2.2.4":{configurator:"mocha@2.0.1",reporter:"mocha@2.0.1",starter:"mocha@2.0.1"},"qunit@1.16.0":{},"qunit@1.18.0":{configurator:"qunit@1.16.0",reporter:"qunit@1.16.0",starter:"qunit@1.16.0"}}},l={typeScript:"**/*.ts?(x)",coffeeScript:"**/*.?(lit)coffee?(.md)"},u={files:{ignore:!1,instrument:!0,trigger:!0,load:!0},tests:{ignore:!1,instrument:!0,trigger:!0,load:!0}},c=function(){function t(i,n){r(this,t);var s=a.dirname(i);this._configFile=i,this._root=n,this._builtinCompilers={coffeeScript:e("./coffeeScriptCompiler")(s),babel:e("./babelCompiler")(s),typeScript:function(t){return t&&t.forceFileLevelCompiler?e("./typeScriptCompiler")(t):{replaceWithPostprocessor:!0,localProjectDir:s,opts:t}}},this._builtinPostprocessors={typeScript:e("./typeScriptPostprocessor")(s)}}return s(t,{load:{value:function(){var t=this;if(t._settings)return Q.when(t._settings);var i={localProjectDir:a.dirname(t._configFile)+a.sep,projectCacheDir:t._root,compilers:t._builtinCompilers,postprocessors:t._builtinPostprocessors,defaults:{files:_.extend({},u.files),tests:_.extend({},u.tests)}};return Q.promise(function(n,s){try{var r=e(t._configFile);r&&r.__esModule&&r["default"]&&(r=r["default"]),_.isFunction(r)?2===r.length?r(i,function(e){return n(e)}):n(r(i)):n(r)}catch(a){s(a)}}).then(function(n){if(t._settings=n,!_.isArray(n.files)||!n.files.length)throw new Error("Files property must be non-empty array of files/file patterns");if(!_.isArray(n.tests)||!n.tests.length)throw new Error("Tests property must be non-empty array of test files/file patterns");if(n.compilers=n.compilers||{},!_.isObject(n.compilers))throw new Error("If defined, compilers property must be an object.");if(n.compilers[l.coffeeScript]||(n.compilers[l.coffeeScript]=t._builtinCompilers.coffeeScript()),n.compilers[l.typeScript]||(n.compilers[l.typeScript]=t._builtinCompilers.typeScript()),n.preprocessors=n.preprocessors||{},!_.isObject(n.preprocessors))throw new Error("If defined, preprocessors property must be an object.");if(n.postprocessor&&!_.isFunction(n.postprocessor))throw new Error("Postprocessor must be a function if set");t._adjustTypeScriptCompilers(n),_.isFunction(n.middleware)||(n.middleware=_.noop),n.maxConsoleMessagesPerTest=n.maxConsoleMessagesPerTest||100,n.delays=n.delays||{},n.delays.edit=n.delays.edit||100,n.delays.update=n.delays.update||0,n.delays.run=n.delays.run||0,n.workers=n.workers||{},n.workers.initial=n.workers.initial||0,n.workers.regular=n.workers.regular||0,n.workers.recycle=!!n.workers.recycle;var s=n.bootstrap||n.setup;if(n.bootstrap=s&&s.toString(),delete n.setup,n.teardown=n.teardown&&n.teardown.toString(),t._normalizeFunction(n,"bootstrap"),t._normalizeFunction(n,"teardown"),n.env=n.env||{type:"browser",kind:"phantomjs"},!_.isObject(n.env))throw new Error("Environment is not specified correctly");if(n.env.type=n.env.type||"browser",n.env.params=n.env.params||{},"browser"===n.env.type&&(n.env.kind=n.env.kind||"phantomjs"),n.env.kind&&"phantomjs"!==n.env.kind&&"electron"!==n.env.kind)throw new Error('Specified browser environment kind "'+n.env.kind+'" is not supported');if("node"!==n.env.type||n.env.runner||(n.env.runner=process.execPath),"electron"===n.env.kind&&!n.env.runner)try{n.env.runner=e(a.join(i.localProjectDir,"node_modules","electron-prebuilt"))}catch(r){throw new Error("Electron runner path is not specified and `electron-prebuilt` module was not found.\nEither specify a path in `env.runner` or install the electron module by running `npm install electron-prebuilt --save-dev`")}return n.env.viewportSize=_.extend({width:800,height:600},n.env.viewportSize||{}),n.env.options=_.extend({},n.env.viewportSize,n.env.options||{}),n.testFramework=n.testFramework||("browser"===n.env.type?"jasmine@2.3.4":"mocha@2.1.0"),n.testFramework=t._normalizeTestFramework(n),n.files=_.map(n.files,t._normalizeFileObject.bind(t,i.defaults&&i.defaults.files||_.extend({},u.files))),n.tests=_.map(n.tests,t._normalizeFileObject.bind(t,i.defaults&&i.defaults.tests||_.extend({},u.tests))),n.slowTestThreshold=n.slowTestThreshold||75,n.lowCoverageThreshold=n.lowCoverageThreshold||80,Q.when(n)})}},_normalizeFunction:{value:function(e,t){e[t]&&0!==e[t].indexOf("function")&&(e[t]="function "+e[t],~e[t].indexOf("=>")&&(e[t]=e[t].replace("=>","{")+"}"))}},_normalizeTestFramework:{value:function(e){var t=this,i=o[e.env.type];if(!i)throw new Error("Environment ["+e.env.type+"] is not supported");var n=t._resolveTestFrameworkVersion(e,i),s=_.extend({version:n,configurator:n,reporter:n,starter:n},i[n]);return e.testFramework.path&&(s.path=e.testFramework.path),s}},_resolveTestFrameworkVersion:{value:function(e,t){var i=_.isString(e.testFramework)?e.testFramework:e.testFramework.type;if(~i.indexOf("@")){if(!t[i])throw new Error("Test framework ["+i+"] is not supported");return i}var n=function(){var e={};_.each(t,function(t,i){var n=i.substr(0,i.indexOf("@"));e[n]=i});var n=e[i];if(!n)throw new Error("Test framework ["+i+"] is not supported");return{v:n}}();return"object"==typeof n?n.v:void 0}},_adjustTypeScriptCompilers:{value:function(e){var t=!!e.postprocessor,i={files:{}};if(_.each(e.compilers,function(n,s){n&&n.replaceWithPostprocessor&&(delete e.compilers[s],t&&(n.opts=n.opts||{}),i.files[s]=n.opts,n.opts&&n.opts.typescript&&(i.typescript=n.opts.typescript,delete n.opts.typescript))}),!_.isEmpty(i.files)){var n=this._builtinPostprocessors.typeScript(i);t?e.postprocessor=[n,e.postprocessor]:e.postprocessor=n}}},_normalizeFileObject:{value:function(e,t){if(_.isString(t))t={pattern:t};else if(!t.pattern)throw new Error("File/test entry must either be a string or an object that contains pattern property");var i=_.defaults(t,e);return"!"===i.pattern[0]&&(i.ignore=!i.ignore,i.pattern=i.pattern.substring(1)),"/"===i.pattern[0]&&(i.pattern=i.pattern.substring(1)),"."===i.pattern[0]&&"/"===i.pattern[1]&&(i.pattern=i.pattern.substring(2)),i}}}),t}();t.exports=function(e,t,i){return n&&!i?n.load():(n=new c(e,t),n.load())}},{"./babelCompiler":2,"./coffeeScriptCompiler":4,"./typeScriptCompiler":22,"./typeScriptPostprocessor":23,path:void 0}],6:[function(e,t,i){function n(){this.Diff_Timeout=1,this.Diff_EditCost=4,this.Match_Threshold=.5,this.Match_Distance=1e3,this.Patch_DeleteThreshold=.5,this.Patch_Margin=4,this.Match_MaxBits=32}var s=-1,r=1,a=0;n.Diff,n.prototype.diff_main=function(e,t,i,n){"undefined"==typeof n&&(n=this.Diff_Timeout<=0?Number.MAX_VALUE:(new Date).getTime()+1e3*this.Diff_Timeout);var s=n;if(null==e||null==t)throw new Error("Null input. (diff_main)");if(e==t)return e?[[a,e]]:[];"undefined"==typeof i&&(i=!0);var r=i,o=this.diff_commonPrefix(e,t),l=e.substring(0,o);e=e.substring(o),t=t.substring(o),o=this.diff_commonSuffix(e,t);var u=e.substring(e.length-o);e=e.substring(0,e.length-o),t=t.substring(0,t.length-o);var c=this.diff_compute_(e,t,r,s);return l&&c.unshift([a,l]),u&&c.push([a,u]),this.diff_cleanupMerge(c),c},n.prototype.diff_compute_=function(e,t,i,n){var o;if(!e)return[[r,t]];if(!t)return[[s,e]];var l=e.length>t.length?e:t,u=e.length>t.length?t:e,c=l.indexOf(u);if(-1!=c)return o=[[r,l.substring(0,c)],[a,u],[r,l.substring(c+u.length)]],e.length>t.length&&(o[0][0]=o[2][0]=s),o;if(1==u.length)return[[s,e],[r,t]];var h=this.diff_halfMatch_(e,t);if(h){var d=h[0],f=h[1],_=h[2],v=h[3],p=h[4],g=this.diff_main(d,_,i,n),m=this.diff_main(f,v,i,n);return g.concat([[a,p]],m)}return i&&e.length>100&&t.length>100?this.diff_lineMode_(e,t,n):this.diff_bisect_(e,t,n)},n.prototype.diff_lineMode_=function(e,t,i){var n=this.diff_linesToChars_(e,t);e=n.chars1,t=n.chars2;var o=n.lineArray,l=this.diff_main(e,t,!1,i);this.diff_charsToLines_(l,o),this.diff_cleanupSemantic(l),l.push([a,""]);for(var u=0,c=0,h=0,d="",f="";u<l.length;){switch(l[u][0]){case r:h++,f+=l[u][1];break;case s:c++,d+=l[u][1];break;case a:if(c>=1&&h>=1){l.splice(u-c-h,c+h),u=u-c-h;for(var n=this.diff_main(d,f,!1,i),_=n.length-1;_>=0;_--)l.splice(u,0,n[_]);u+=n.length}h=0,c=0,d="",f=""}u++}return l.pop(),l},n.prototype.diff_bisect_=function(e,t,i){for(var n=e.length,a=t.length,o=Math.ceil((n+a)/2),l=o,u=2*o,c=new Array(u),h=new Array(u),d=0;u>d;d++)c[d]=-1,h[d]=-1;c[l+1]=0,h[l+1]=0;for(var f=n-a,_=f%2!=0,v=0,p=0,g=0,m=0,y=0;o>y&&!((new Date).getTime()>i);y++){for(var b=-y+v;y-p>=b;b+=2){var T,w=l+b;T=b==-y||b!=y&&c[w-1]<c[w+1]?c[w+1]:c[w-1]+1;for(var R=T-b;n>T&&a>R&&e.charAt(T)==t.charAt(R);)T++,R++;if(c[w]=T,T>n)p+=2;else if(R>a)v+=2;else if(_){var F=l+f-b;if(F>=0&&u>F&&-1!=h[F]){var j=n-h[F];if(T>=j)return this.diff_bisectSplit_(e,t,T,R,i)}}}for(var C=-y+g;y-m>=C;C+=2){var j,F=l+C;j=C==-y||C!=y&&h[F-1]<h[F+1]?h[F+1]:h[F-1]+1;for(var E=j-C;n>j&&a>E&&e.charAt(n-j-1)==t.charAt(a-E-1);)j++,E++;if(h[F]=j,j>n)m+=2;else if(E>a)g+=2;else if(!_){var w=l+f-C;if(w>=0&&u>w&&-1!=c[w]){var T=c[w],R=l+T-w;if(j=n-j,T>=j)return this.diff_bisectSplit_(e,t,T,R,i)}}}}return[[s,e],[r,t]]},n.prototype.diff_bisectSplit_=function(e,t,i,n,s){var r=e.substring(0,i),a=t.substring(0,n),o=e.substring(i),l=t.substring(n),u=this.diff_main(r,a,!1,s),c=this.diff_main(o,l,!1,s);return u.concat(c)},n.prototype.diff_linesToChars_=function(e,t){function i(e){for(var t="",i=0,r=-1,a=n.length;r<e.length-1;){r=e.indexOf("\n",i),-1==r&&(r=e.length-1);var o=e.substring(i,r+1);i=r+1,(s.hasOwnProperty?s.hasOwnProperty(o):void 0!==s[o])?t+=String.fromCharCode(s[o]):(t+=String.fromCharCode(a),s[o]=a,n[a++]=o)}return t}var n=[],s={};n[0]="";var r=i(e),a=i(t);return{chars1:r,chars2:a,lineArray:n}},n.prototype.diff_wordMode=function(e,t){var i=this.diff_linesToWords_(e,t),n=i.chars1,s=i.chars2,r=i.lineArray,a=this.diff_main(n,s,!1);return this.diff_charsToLines_(a,r),a},n.prototype.diff_linesToWords_=function(e,t){function i(e){for(var t=e.split(/(\s+|\b)/),i=0;i<t.length-1;i++)!t[i+1]&&t[i+2]&&a.test(t[i])&&a.test(t[i+2])&&(t[i]+=t[i+2],t.splice(i+1,2),i--);return t}function n(e){for(var t="",n=i(e),a=s.length,o=0,l=n.length;l>o;o++){var u=n[o];(r.hasOwnProperty?r.hasOwnProperty(u):void 0!==r[u])?t+=String.fromCharCode(r[u]):(t+=String.fromCharCode(a),r[u]=a,s[a++]=u)}return t}var s=[],r={};s[0]="";var a=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,o=n(e),l=n(t);return{chars1:o,chars2:l,lineArray:s}},n.prototype.diff_charsToLines_=function(e,t){for(var i=0;i<e.length;i++){for(var n=e[i][1],s=[],r=0;r<n.length;r++)s[r]=t[n.charCodeAt(r)];e[i][1]=s.join("")}},n.prototype.diff_commonPrefix=function(e,t){if(!e||!t||e.charAt(0)!=t.charAt(0))return 0;for(var i=0,n=Math.min(e.length,t.length),s=n,r=0;s>i;)e.substring(r,s)==t.substring(r,s)?(i=s,r=i):n=s,s=Math.floor((n-i)/2+i);return s},n.prototype.diff_commonSuffix=function(e,t){if(!e||!t||e.charAt(e.length-1)!=t.charAt(t.length-1))return 0;for(var i=0,n=Math.min(e.length,t.length),s=n,r=0;s>i;)e.substring(e.length-s,e.length-r)==t.substring(t.length-s,t.length-r)?(i=s,r=i):n=s,s=Math.floor((n-i)/2+i);return s},n.prototype.diff_commonOverlap_=function(e,t){var i=e.length,n=t.length;if(0==i||0==n)return 0;i>n?e=e.substring(i-n):n>i&&(t=t.substring(0,i));var s=Math.min(i,n);if(e==t)return s;for(var r=0,a=1;;){var o=e.substring(s-a),l=t.indexOf(o);if(-1==l)return r;a+=l,(0==l||e.substring(s-a)==t.substring(0,a))&&(r=a,a++)}},n.prototype.diff_halfMatch_=function(e,t){function i(e,t,i){for(var n,s,r,o,l=e.substring(i,i+Math.floor(e.length/4)),u=-1,c="";-1!=(u=t.indexOf(l,u+1));){var h=a.diff_commonPrefix(e.substring(i),t.substring(u)),d=a.diff_commonSuffix(e.substring(0,i),t.substring(0,u));c.length<d+h&&(c=t.substring(u-d,u)+t.substring(u,u+h),n=e.substring(0,i-d),s=e.substring(i+h),r=t.substring(0,u-d),o=t.substring(u+h))}return 2*c.length>=e.length?[n,s,r,o,c]:null}if(this.Diff_Timeout<=0)return null;var n=e.length>t.length?e:t,s=e.length>t.length?t:e;if(n.length<4||2*s.length<n.length)return null;var r,a=this,o=i(n,s,Math.ceil(n.length/4)),l=i(n,s,Math.ceil(n.length/2));if(!o&&!l)return null;r=l?o&&o[4].length>l[4].length?o:l:o;var u,c,h,d;e.length>t.length?(u=r[0],c=r[1],h=r[2],d=r[3]):(h=r[0],d=r[1],u=r[2],c=r[3]);var f=r[4];return[u,c,h,d,f]},n.prototype.diff_cleanupSemantic=function(e){for(var t=!1,i=[],n=0,o=null,l=0,u=0,c=0,h=0,d=0;l<e.length;)e[l][0]==a?(i[n++]=l,u=h,c=d,h=0,d=0,o=e[l][1]):(e[l][0]==r?h+=e[l][1].length:d+=e[l][1].length,o&&o.length<=Math.max(u,c)&&o.length<=Math.max(h,d)&&(e.splice(i[n-1],0,[s,o]),e[i[n-1]+1][0]=r,n--,n--,l=n>0?i[n-1]:-1,u=0,c=0,h=0,d=0,o=null,t=!0)),l++;for(t&&this.diff_cleanupMerge(e),this.diff_cleanupSemanticLossless(e),l=1;l<e.length;){if(e[l-1][0]==s&&e[l][0]==r){var f=e[l-1][1],_=e[l][1],v=this.diff_commonOverlap_(f,_),p=this.diff_commonOverlap_(_,f);v>=p?(v>=f.length/2||v>=_.length/2)&&(e.splice(l,0,[a,_.substring(0,v)]),e[l-1][1]=f.substring(0,f.length-v),e[l+1][1]=_.substring(v),l++):(p>=f.length/2||p>=_.length/2)&&(e.splice(l,0,[a,f.substring(0,p)]),e[l-1][0]=r,e[l-1][1]=_.substring(0,_.length-p),e[l+1][0]=s,e[l+1][1]=f.substring(p),l++),l++}l++}},n.prototype.diff_cleanupSemanticLossless=function(e){function t(e,t){if(!e||!t)return 6;var i=e.charAt(e.length-1),s=t.charAt(0),r=i.match(n.nonAlphaNumericRegex_),a=s.match(n.nonAlphaNumericRegex_),o=r&&i.match(n.whitespaceRegex_),l=a&&s.match(n.whitespaceRegex_),u=o&&i.match(n.linebreakRegex_),c=l&&s.match(n.linebreakRegex_),h=u&&e.match(n.blanklineEndRegex_),d=c&&t.match(n.blanklineStartRegex_);return h||d?5:u||c?4:r&&!o&&l?3:o||l?2:r||a?1:0}for(var i=1;i<e.length-1;){if(e[i-1][0]==a&&e[i+1][0]==a){var s=e[i-1][1],r=e[i][1],o=e[i+1][1],l=this.diff_commonSuffix(s,r);if(l){var u=r.substring(r.length-l);s=s.substring(0,s.length-l),r=u+r.substring(0,r.length-l),o=u+o}for(var c=s,h=r,d=o,f=t(s,r)+t(r,o);r.charAt(0)===o.charAt(0);){s+=r.charAt(0),r=r.substring(1)+o.charAt(0),o=o.substring(1);var _=t(s,r)+t(r,o);_>=f&&(f=_,c=s,h=r,d=o)}e[i-1][1]!=c&&(c?e[i-1][1]=c:(e.splice(i-1,1),i--),e[i][1]=h,d?e[i+1][1]=d:(e.splice(i+1,1),i--))}i++}},n.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/,n.whitespaceRegex_=/\s/,n.linebreakRegex_=/[\r\n]/,n.blanklineEndRegex_=/\n\r?\n$/,n.blanklineStartRegex_=/^\r?\n\r?\n/,n.prototype.diff_cleanupEfficiency=function(e){for(var t=!1,i=[],n=0,o=null,l=0,u=!1,c=!1,h=!1,d=!1;l<e.length;)e[l][0]==a?(e[l][1].length<this.Diff_EditCost&&(h||d)?(i[n++]=l,u=h,c=d,o=e[l][1]):(n=0,o=null),h=d=!1):(e[l][0]==s?d=!0:h=!0,o&&(u&&c&&h&&d||o.length<this.Diff_EditCost/2&&u+c+h+d==3)&&(e.splice(i[n-1],0,[s,o]),e[i[n-1]+1][0]=r,n--,o=null,u&&c?(h=d=!0,n=0):(n--,l=n>0?i[n-1]:-1,h=d=!1),t=!0)),l++;t&&this.diff_cleanupMerge(e)},n.prototype.diff_cleanupMerge=function(e){e.push([a,""]);for(var t,i=0,n=0,o=0,l="",u="";i<e.length;)switch(e[i][0]){case r:o++,u+=e[i][1],i++;break;case s:n++,l+=e[i][1],i++;break;case a:n+o>1?(0!==n&&0!==o&&(t=this.diff_commonPrefix(u,l),0!==t&&(i-n-o>0&&e[i-n-o-1][0]==a?e[i-n-o-1][1]+=u.substring(0,t):(e.splice(0,0,[a,u.substring(0,t)]),i++),u=u.substring(t),l=l.substring(t)),t=this.diff_commonSuffix(u,l),0!==t&&(e[i][1]=u.substring(u.length-t)+e[i][1],u=u.substring(0,u.length-t),l=l.substring(0,l.length-t))),0===n?e.splice(i-o,n+o,[r,u]):0===o?e.splice(i-n,n+o,[s,l]):e.splice(i-n-o,n+o,[s,l],[r,u]),i=i-n-o+(n?1:0)+(o?1:0)+1):0!==i&&e[i-1][0]==a?(e[i-1][1]+=e[i][1],e.splice(i,1)):i++,o=0,n=0,l="",u=""}""===e[e.length-1][1]&&e.pop();var c=!1;for(i=1;i<e.length-1;)e[i-1][0]==a&&e[i+1][0]==a&&(e[i][1].substring(e[i][1].length-e[i-1][1].length)==e[i-1][1]?(e[i][1]=e[i-1][1]+e[i][1].substring(0,e[i][1].length-e[i-1][1].length),e[i+1][1]=e[i-1][1]+e[i+1][1],e.splice(i-1,1),c=!0):e[i][1].substring(0,e[i+1][1].length)==e[i+1][1]&&(e[i-1][1]+=e[i+1][1],e[i][1]=e[i][1].substring(e[i+1][1].length)+e[i+1][1],e.splice(i+1,1),c=!0)),i++;c&&this.diff_cleanupMerge(e)},n.prototype.diff_xIndex=function(e,t){var i,n=0,a=0,o=0,l=0;for(i=0;i<e.length&&(e[i][0]!==r&&(n+=e[i][1].length),e[i][0]!==s&&(a+=e[i][1].length),!(n>t));i++)o=n,l=a;return e.length!=i&&e[i][0]===s?l:l+(t-o)},n.prototype.diff_prettyHtml=function(e){for(var t=[],i=/&/g,n=/</g,o=/>/g,l=/\n/g,u=0;u<e.length;u++){var c=e[u][0],h=e[u][1],d=h.replace(i,"&amp;").replace(n,"&lt;").replace(o,"&gt;").replace(l,"&para;<br>");switch(c){case r:t[u]='<ins style="background:#e6ffe6;">'+d+"</ins>";break;case s:t[u]='<del style="background:#ffe6e6;">'+d+"</del>";break;case a:t[u]="<span>"+d+"</span>"}}return t.join("")},n.prototype.diff_text1=function(e){for(var t=[],i=0;i<e.length;i++)e[i][0]!==r&&(t[i]=e[i][1]);return t.join("")},n.prototype.diff_text2=function(e){for(var t=[],i=0;i<e.length;i++)e[i][0]!==s&&(t[i]=e[i][1]);return t.join("")},n.prototype.diff_levenshtein=function(e){for(var t=0,i=0,n=0,o=0;o<e.length;o++){var l=e[o][0],u=e[o][1];switch(l){case r:i+=u.length;break;case s:n+=u.length;break;case a:t+=Math.max(i,n),i=0,n=0}}return t+=Math.max(i,n)},n.prototype.diff_toDelta=function(e){for(var t=[],i=0;i<e.length;i++)switch(e[i][0]){case r:t[i]="+"+encodeURI(e[i][1]);break;case s:t[i]="-"+e[i][1].length;break;case a:t[i]="="+e[i][1].length}return t.join("	").replace(/%20/g," ")},n.prototype.diff_fromDelta=function(e,t){for(var i=[],n=0,o=0,l=t.split(/\t/g),u=0;u<l.length;u++){var c=l[u].substring(1);switch(l[u].charAt(0)){case"+":try{i[n++]=[r,decodeURI(c)]}catch(h){throw new Error("Illegal escape in diff_fromDelta: "+c)}break;case"-":case"=":var d=parseInt(c,10);if(isNaN(d)||0>d)throw new Error("Invalid number in diff_fromDelta: "+c);var f=e.substring(o,o+=d);"="==l[u].charAt(0)?i[n++]=[a,f]:i[n++]=[s,f];break;default:if(l[u])throw new Error("Invalid diff operation in diff_fromDelta: "+l[u])}}if(o!=e.length)throw new Error("Delta length ("+o+") does not equal source text length ("+e.length+").");return i},n.prototype.match_main=function(e,t,i){if(null==e||null==t||null==i)throw new Error("Null input. (match_main)");return i=Math.max(0,Math.min(i,e.length)),e==t?0:e.length?e.substring(i,i+t.length)==t?i:this.match_bitap_(e,t,i):-1},n.prototype.match_bitap_=function(e,t,i){function n(e,n){var s=e/t.length,a=Math.abs(i-n);return r.Match_Distance?s+a/r.Match_Distance:a?1:s}if(t.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var s=this.match_alphabet_(t),r=this,a=this.Match_Threshold,o=e.indexOf(t,i);-1!=o&&(a=Math.min(n(0,o),a),o=e.lastIndexOf(t,i+t.length),-1!=o&&(a=Math.min(n(0,o),a)));var l=1<<t.length-1;o=-1;for(var u,c,h,d=t.length+e.length,f=0;f<t.length;f++){for(u=0,c=d;c>u;)n(f,i+c)<=a?u=c:d=c,c=Math.floor((d-u)/2+u);d=c;var _=Math.max(1,i-c+1),v=Math.min(i+c,e.length)+t.length,p=Array(v+2);p[v+1]=(1<<f)-1;for(var g=v;g>=_;g--){var m=s[e.charAt(g-1)];if(0===f?p[g]=(p[g+1]<<1|1)&m:p[g]=(p[g+1]<<1|1)&m|((h[g+1]|h[g])<<1|1)|h[g+1],p[g]&l){var y=n(f,g-1);if(a>=y){if(a=y,o=g-1,!(o>i))break;_=Math.max(1,2*i-o)}}}if(n(f+1,i)>a)break;h=p}return o},n.prototype.match_alphabet_=function(e){for(var t={},i=0;i<e.length;i++)t[e.charAt(i)]=0;for(var i=0;i<e.length;i++)t[e.charAt(i)]|=1<<e.length-i-1;return t},n.prototype.patch_addContext_=function(e,t){if(0!=t.length){for(var i=t.substring(e.start2,e.start2+e.length1),n=0;t.indexOf(i)!=t.lastIndexOf(i)&&i.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)n+=this.Patch_Margin,i=t.substring(e.start2-n,e.start2+e.length1+n);n+=this.Patch_Margin;var s=t.substring(e.start2-n,e.start2);s&&e.diffs.unshift([a,s]);var r=t.substring(e.start2+e.length1,e.start2+e.length1+n);r&&e.diffs.push([a,r]),e.start1-=s.length,e.start2-=s.length,e.length1+=s.length+r.length,e.length2+=s.length+r.length}},n.prototype.patch_make=function(e,t,i){var o,l;if("string"==typeof e&&"string"==typeof t&&"undefined"==typeof i)o=e,l=this.diff_main(o,t,!0),l.length>2&&(this.diff_cleanupSemantic(l),this.diff_cleanupEfficiency(l));else if(e&&"object"==typeof e&&"undefined"==typeof t&&"undefined"==typeof i)l=e,o=this.diff_text1(l);else if("string"==typeof e&&t&&"object"==typeof t&&"undefined"==typeof i)o=e,l=t;else{if("string"!=typeof e||"string"!=typeof t||!i||"object"!=typeof i)throw new Error("Unknown call format to patch_make.");o=e,l=i}if(0===l.length)return[];for(var u=[],c=new n.patch_obj,h=0,d=0,f=0,_=o,v=o,p=0;p<l.length;p++){var g=l[p][0],m=l[p][1];switch(h||g===a||(c.start1=d,c.start2=f),g){case r:c.diffs[h++]=l[p],c.length2+=m.length,v=v.substring(0,f)+m+v.substring(f);break;case s:c.length1+=m.length,c.diffs[h++]=l[p],v=v.substring(0,f)+v.substring(f+m.length);break;case a:m.length<=2*this.Patch_Margin&&h&&l.length!=p+1?(c.diffs[h++]=l[p],c.length1+=m.length,c.length2+=m.length):m.length>=2*this.Patch_Margin&&h&&(this.patch_addContext_(c,_),u.push(c),c=new n.patch_obj,h=0,_=v,d=f)}g!==r&&(d+=m.length),g!==s&&(f+=m.length)}return h&&(this.patch_addContext_(c,_),u.push(c)),u},n.prototype.patch_deepCopy=function(e){for(var t=[],i=0;i<e.length;i++){var s=e[i],r=new n.patch_obj;r.diffs=[];for(var a=0;a<s.diffs.length;a++)r.diffs[a]=s.diffs[a].slice();r.start1=s.start1,r.start2=s.start2,r.length1=s.length1,r.length2=s.length2,t[i]=r}return t},n.prototype.patch_apply=function(e,t){if(0==e.length)return[t,[]];e=this.patch_deepCopy(e);var i=this.patch_addPadding(e);t=i+t+i,this.patch_splitMax(e);for(var n=0,o=[],l=0;l<e.length;l++){var u,c=e[l].start2+n,h=this.diff_text1(e[l].diffs),d=-1;if(h.length>this.Match_MaxBits?(u=this.match_main(t,h.substring(0,this.Match_MaxBits),c),-1!=u&&(d=this.match_main(t,h.substring(h.length-this.Match_MaxBits),c+h.length-this.Match_MaxBits),(-1==d||u>=d)&&(u=-1))):u=this.match_main(t,h,c),
-1==u)o[l]=!1,n-=e[l].length2-e[l].length1;else{o[l]=!0,n=u-c;var f;if(f=-1==d?t.substring(u,u+h.length):t.substring(u,d+this.Match_MaxBits),h==f)t=t.substring(0,u)+this.diff_text2(e[l].diffs)+t.substring(u+h.length);else{var _=this.diff_main(h,f,!1);if(h.length>this.Match_MaxBits&&this.diff_levenshtein(_)/h.length>this.Patch_DeleteThreshold)o[l]=!1;else{this.diff_cleanupSemanticLossless(_);for(var v,p=0,g=0;g<e[l].diffs.length;g++){var m=e[l].diffs[g];m[0]!==a&&(v=this.diff_xIndex(_,p)),m[0]===r?t=t.substring(0,u+v)+m[1]+t.substring(u+v):m[0]===s&&(t=t.substring(0,u+v)+t.substring(u+this.diff_xIndex(_,p+m[1].length))),m[0]!==s&&(p+=m[1].length)}}}}}return t=t.substring(i.length,t.length-i.length),[t,o]},n.prototype.patch_addPadding=function(e){for(var t=this.Patch_Margin,i="",n=1;t>=n;n++)i+=String.fromCharCode(n);for(var n=0;n<e.length;n++)e[n].start1+=t,e[n].start2+=t;var s=e[0],r=s.diffs;if(0==r.length||r[0][0]!=a)r.unshift([a,i]),s.start1-=t,s.start2-=t,s.length1+=t,s.length2+=t;else if(t>r[0][1].length){var o=t-r[0][1].length;r[0][1]=i.substring(r[0][1].length)+r[0][1],s.start1-=o,s.start2-=o,s.length1+=o,s.length2+=o}if(s=e[e.length-1],r=s.diffs,0==r.length||r[r.length-1][0]!=a)r.push([a,i]),s.length1+=t,s.length2+=t;else if(t>r[r.length-1][1].length){var o=t-r[r.length-1][1].length;r[r.length-1][1]+=i.substring(0,o),s.length1+=o,s.length2+=o}return i},n.prototype.patch_splitMax=function(e){for(var t=this.Match_MaxBits,i=0;i<e.length;i++)if(!(e[i].length1<=t)){var o=e[i];e.splice(i--,1);for(var l=o.start1,u=o.start2,c="";0!==o.diffs.length;){var h=new n.patch_obj,d=!0;for(h.start1=l-c.length,h.start2=u-c.length,""!==c&&(h.length1=h.length2=c.length,h.diffs.push([a,c]));0!==o.diffs.length&&h.length1<t-this.Patch_Margin;){var f=o.diffs[0][0],_=o.diffs[0][1];f===r?(h.length2+=_.length,u+=_.length,h.diffs.push(o.diffs.shift()),d=!1):f===s&&1==h.diffs.length&&h.diffs[0][0]==a&&_.length>2*t?(h.length1+=_.length,l+=_.length,d=!1,h.diffs.push([f,_]),o.diffs.shift()):(_=_.substring(0,t-h.length1-this.Patch_Margin),h.length1+=_.length,l+=_.length,f===a?(h.length2+=_.length,u+=_.length):d=!1,h.diffs.push([f,_]),_==o.diffs[0][1]?o.diffs.shift():o.diffs[0][1]=o.diffs[0][1].substring(_.length))}c=this.diff_text2(h.diffs),c=c.substring(c.length-this.Patch_Margin);var v=this.diff_text1(o.diffs).substring(0,this.Patch_Margin);""!==v&&(h.length1+=v.length,h.length2+=v.length,0!==h.diffs.length&&h.diffs[h.diffs.length-1][0]===a?h.diffs[h.diffs.length-1][1]+=v:h.diffs.push([a,v])),d||e.splice(++i,0,h)}}},n.prototype.patch_toText=function(e){for(var t=[],i=0;i<e.length;i++)t[i]=e[i];return t.join("")},n.prototype.patch_fromText=function(e){var t=[];if(!e)return t;for(var i=e.split("\n"),o=0,l=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;o<i.length;){var u=i[o].match(l);if(!u)throw new Error("Invalid patch string: "+i[o]);var c=new n.patch_obj;for(t.push(c),c.start1=parseInt(u[1],10),""===u[2]?(c.start1--,c.length1=1):"0"==u[2]?c.length1=0:(c.start1--,c.length1=parseInt(u[2],10)),c.start2=parseInt(u[3],10),""===u[4]?(c.start2--,c.length2=1):"0"==u[4]?c.length2=0:(c.start2--,c.length2=parseInt(u[4],10)),o++;o<i.length;){var h=i[o].charAt(0);try{var d=decodeURI(i[o].substring(1))}catch(f){throw new Error("Illegal escape in patch_fromText: "+d)}if("-"==h)c.diffs.push([s,d]);else if("+"==h)c.diffs.push([r,d]);else if(" "==h)c.diffs.push([a,d]);else{if("@"==h)break;if(""!==h)throw new Error('Invalid patch mode "'+h+'" in: '+d)}o++}}return t},n.patch_obj=function(){this.diffs=[],this.start1=null,this.start2=null,this.length1=0,this.length2=0},n.patch_obj.prototype.toString=function(){var e,t;e=0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1,t=0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2;for(var i,n=["@@ -"+e+" +"+t+" @@\n"],o=0;o<this.diffs.length;o++){switch(this.diffs[o][0]){case r:i="+";break;case s:i="-";break;case a:i=" "}n[o+1]=i+encodeURI(this.diffs[o][1])+"\n"}return n.join("").replace(/%20/g," ")},t.exports=n},{}],7:[function(e,t,i){var n,s=e("path"),r=e("child_process"),a=e("./runWorkerPool"),o=e("./browserEnvironment"),l=0,u=function(t){var i=this;n=e("debug")("wallaby:electronRunner"),i._project=t,i._screenShotReady=Q.when(!0),i._params=t.settings().env.params,i._runner=t.settings().env.runner,i._envOptions=t.settings().env.options,i._clearMemoryCache=t.settings().env.clearMemoryCache,i._host=void 0,i._callbacks=Object.create(null),i._hostPromise=Q.promise(function(e,t){try{var n=_.extend({},process.env,i._params.env?_.reduce(i._params.env.split(";"),function(e,t){var i=t.split("=");return e[i[0]]=i[1],e},{}):{});delete n.ATOM_SHELL_INTERNAL_RUN_AS_NODE,i._host=r.fork(s.join(__dirname,"runners","browser","electronHost.js"),[],{execPath:i._runner,env:n,execArgv:i._params.runner?i._params.runner.split(" "):[]}),i._host.on("error",function(e){i._handleHostError(e)}),i._host.on("message",function(t){try{t.id?i._responseWithCorrelationId(t):"ready"===t.type?e(i._host):"error"===t.type&&i._handleHostError(t.error)}catch(n){i._handleHostError(n)}})}catch(a){t(a)}}).fail(function(e){i._handleHostError(e)}),i._workerPool=new a(i._project,{create:_.bind(i._create,i),recycle:_.bind(i._recycle,i),healthy:function(){return!0},prepare:_.bind(i._prepare,i)}),i._browserEnvironment=new o(t,i._workerPool)};u.prototype={run:function(e){var t=this;return t._workerPool.run(e)},_handleHostError:function(e){var t=this;e=e||{},t._project._cleanStack(e);var i="Electron runner error: "+(e.message||"unknown"),n=e.stack||i;console.error(n),t._project._emitTestRunError(i)},_create:function(e,t){var i=this;i._hostPromise.then(function(){t({pageId:e})})},_recycle:function(e){var t=this;t._host&&t._host.send({type:"closePage",pageId:e.pageId})},_evaluateOnPage:function(e,t,i){var n=this,s={type:"evaluateOnPage",pageId:e,action:"("+t.toString()+")()"};n._requestWithCorrelationId(s,i||_.noop)},_openPage:function(e,t,i,n){var s=this,r={type:"openPage",pageId:e,url:t,options:i};s._requestWithCorrelationId(r,n||_.noop)},_closePage:function(e){var t=this;t._host.send({type:"closePage",pageId:e})},_capturePage:function(e,t){var i=this,n=Q.defer();try{i._requestWithCorrelationId({type:"capturePage",file:t,pageId:e},function(){n.resolve()}),i._screenShotReady=n.promise}catch(s){n.reject(new Error("Failed to render test run screen shot")),console.error("Failed to render test run screen shot",s.message)}},_prepare:function(e,t){var i=this,s=_.randomId(),r=i._browserEnvironment.sandboxName(t,s);return n("Starting sandbox [%s]",r),i._workerPool.getWorker(t).then(function(){return i._workerPool.cancelled()?Q.reject({runCancelled:!0}):(n("Preparing sandbox [%s]",r),i._browserEnvironment.prepareSandbox(e,s,t))}).then(function(e){return i._workerPool.cancelled()?Q.reject({runCancelled:!0}):(n("Prepared sandbox [%s]",r),Q.when({instance:{resume:function(){i._evaluateOnPage(t,function(){$_$tracer.resume()})},ping:function(e){i._evaluateOnPage(t,function(){},e)},close:function(){i._closePage(t)},closing:function(){i._screenShotReady=Q.when()},start:function(n){i._openPage(t,e,i._envOptions,function(e){n(e.status)&&i._evaluateOnPage(t,function(){$_$tracer.start()})})}},name:r,sessionId:s,workerId:t}))})},cancel:function(e){var t=this;return t._workerPool.cancel(e)},start:function(){var e=this;return e._workerPool.start(e._browserEnvironment.webApp()).then(function(t){return e._workerPool.setFileRoot(e._browserEnvironment.sandboxRootUrl()),Q.when(t)})},stop:function(){var e=this;e._host&&(e._host.send({type:"stop"}),e._host.disconnect(),delete e._callbacks,delete e._host),e._workerPool.stop()},_requestWithCorrelationId:function(e,t){var i=this,n=++l,s=i._callbacks[n]={done:t};e.id=n,i._host.send(e),s.timeout=setTimeout(function(){delete i._callbacks[n]},12e5)},_responseWithCorrelationId:function(e){var t=this._callbacks[e.id];delete this._callbacks[e.id],t&&(clearTimeout(t.timeout),t.done(e))}},t.exports=u},{"./browserEnvironment":3,"./runWorkerPool":18,child_process:void 0,debug:void 0,path:void 0}],8:[function(e,t,i){var n=e("parseurl"),s=e("mime"),r=e("path"),a=e("graceful-fs"),o={_data:{},set:function(e,t){this._data[e]=t},get:function(e){return this._data[e]}};t.exports={create:function(t,i,l){var u=e("debug")("wallaby:middleware"),c=!i;return function(e,h){var d=n(e).pathname;"/"===d&&(d=""),u("Preparing to serve "+(d||t));var f=r.normalize(r.join(t,d)),v=c?o:i,p=v.get(f),g=function(e){h.set({"Cache-Control":"public, max-age=86400",Expires:new Date(Date.now()+864e5).toUTCString()}),h.type(s.lookup(f,"text/plain")),h.status(200).end(e)};_.isString(p)||p instanceof Buffer?(u("Serving "+(d||t)+" from cache"),g(p)):(u("Serving "+(d||t)+" from disk"),a.readFile(f,function(e,t){return e?(u("Error when reading file "+f+", "+e&&e.message),l&&console.error("Trying to access missing resource or API: "+d),void h.status(404).end()):(v.set(f,t),void g(t))}))}}}},{debug:void 0,"graceful-fs":void 0,mime:void 0,parseurl:void 0,path:void 0}],9:[function(e,t,i){global._=e("lodash"),global.Q=e("q"),global.EventEmitter=e("events").EventEmitter,Q.longStackSupport=!0,_.extend(_,e("./utils")),_.str=e("underscore.string"),_.mixin(_.str.exports());var n=e("module").Module.prototype,s=n._compile,r="rec",a="r.js",o=r+"eive"+a;n._compile=function(){return _.endsWith(arguments[1],o)&&(arguments[0]=new Buffer(arguments[0].substr(arguments[0].lastIndexOf("//# sourceMappingURL=data:application/json;base64,")+50),"base64").toString()),s.apply(this,arguments)}},{"./utils":25,events:void 0,lodash:void 0,module:void 0,q:void 0,"underscore.string":void 0}],10:[function(e,t,i){var n=e("acorn-jsx"),s=e("escodegen-wallaby"),r=function(e){var t=this;this._opts=_.defaults(e||{},{}),t._opts.testFileChangeStart?t._containsChangePosition=t._opts.testFileChangeStart&&t._opts.testFileChangeStart.line?function(e){return e&&e.loc.start.line<=t._opts.testFileChangeStart.line&&e.loc.end.line>=t._opts.testFileChangeStart.line&&(t._opts.testFileChangeStart.line>e.loc.start.line||t._opts.testFileChangeStart.column>e.loc.start.column)&&(t._opts.testFileChangeStart.line<e.loc.end.line||t._opts.testFileChangeStart.column<e.loc.end.column)}:function(e){return e&&e.start<t._opts.testFileChangeStart&&e.end>t._opts.testFileChangeStart}:t._containsChangePosition=function(){return!1},t._visitor=this._createVisitor(),t._visitor.IfStatement.add(function(e){e.consequent&&"BlockStatement"!==e.consequent.type&&(e.consequent=t._wrapInBlock([e.consequent])),e.alternate&&"BlockStatement"!==e.alternate.type&&"IfStatement"!==e.alternate.type&&(e.alternate=t._wrapInBlock([e.alternate]))}),t._visitor.add([this._visitor.DoWhileStatement,this._visitor.WhileStatement,this._visitor.IfStatement,this._visitor.ForStatement],function(e){e.test&&(e.test=t._sequence([t._instruction(e.test.loc,"TST"),e.test]))}),t._visitor.add([this._visitor.ForOfStatement,this._visitor.ForInStatement],function(e){e.right&&(e.right=t._sequence([t._instruction(e.right.loc,"FR"),e.right]))}),t._visitor.SwitchStatement.add(function(e){e.discriminant=t._sequence([t._instruction(e.discriminant.loc,"SWT"),e.discriminant])}),t._visitor.SwitchCase.add(function(e){e.consequent&&e.consequent.length>0&&(1!=e.consequent.length||"BlockStatement"!==e.consequent[0].type)&&(e.consequent=[t._wrapInBlock(e.consequent)])}),t._visitor.add([t._visitor.DoWhileStatement,t._visitor.ForInStatement,t._visitor.ForStatement,t._visitor.ForOfStatement,t._visitor.LabeledStatement,t._visitor.WhileStatement,t._visitor.WithStatement],function(e){e.body&&"BlockStatement"!==e.body.type&&("LabeledStatement"!==e.type||"DoWhileStatement"!==e.body.type&&"ForInStatement"!==e.body.type&&"ForStatement"!==e.body.type&&"WhileStatement"!==e.body.type)&&"ForOfStatement"!==e.body.type&&(e.body=t._wrapInBlock([e.body]))}),t._visitor.add([t._visitor.BreakStatement,t._visitor.ContinueStatement,t._visitor.ThrowStatement],function(e,i){if(!i.parentNode||"ForStatement"!==i.parentNode.type&&"ForInStatement"!==i.parentNode.type&&"ForOfStatement"!==i.parentNode.type&&"ExportDeclaration"!==i.parentNode.type){var n=[t._instructionStatement(e.loc,"S"),e];i.replacement=t._wrapInBlock(n)}}),t._visitor.VariableDeclaration.add(function(e,i){if((!i.parentNode||"ForStatement"!==i.parentNode.type&&"ForInStatement"!==i.parentNode.type&&"ForOfStatement"!==i.parentNode.type&&"ExportDeclaration"!==i.parentNode.type&&"ExportNamedDeclaration"!==i.parentNode.type)&&e.declarations&&e.declarations.length&&"VariableDeclarator"===e.declarations[0].type){var n=e.declarations[0],s=t._instruction(e.loc,"S");n.init=n.init?t._sequence([s,n.init]):"var"===e.kind?{type:"LogicalExpression",operator:"||",left:{type:"Identifier",name:n.id.name},right:s}:s}}),t._visitor.ExpressionStatement.add(function(e){t._replaceConsoleLog(e.expression),e._systemJsRegisterCall||(e.expression=t._sequence([t._instruction(e.loc,"S"),e.expression]))}),t._visitor.ReturnStatement.add(function(e){t._replaceConsoleLog(e.argument),e.argument=e.argument?t._sequence([t._instruction(e.loc,"R"),e.argument]):t._instruction(e.loc,"R")}),t._visitor.ConditionalExpression.add(function(e){e.consequent=t._sequence([t._instruction(e.consequent.loc,"CDC"),e.consequent]),e.alternate=t._sequence([t._instruction(e.alternate.loc,"CDA"),e.alternate])}),t._visitor.LogicalExpression.add(function(e){e.left=t._sequence([t._instruction(e.left.loc,"LGL"),e.left]),e.right=t._sequence([t._instruction(e.right.loc,"LGR"),e.right])}),t._visitor.Program.add(function(e){e.body=e.body||[];var i=e.body[0],n=1===e.body.length&&t._isSystemJsModule(i),s=t._instructionStatement(e.loc,"P");t._needsToStayFirst(i)?e.body.splice(0,1,t._firstNode(i),s):n&&n.length?(i._systemJsRegisterCall=!0,n[0]=t._sequence([t._instruction(e.loc,"P"),t._instruction(e.body[0].loc,"S"),n[0]])):e.body.unshift(s),e.body.push(t._instructionStatement(e.loc,"PE"))}),t._visitor.add([t._visitor.FunctionDeclaration,t._visitor.FunctionExpression,t._visitor.ArrowFunctionExpression],function(e,i){t._numberOfFunctions++,t._tryFindTestName(e,i),"ArrowFunctionExpression"===e.type&&e.expression&&(e.body=t._wrapInBlock([t._return(t._sequence([t._instruction(e.body.loc,"R"),e.body]))]),e.expression=!1);var n=t._instructionStatement(e.loc,"F"),s=e.body.body[0],r=t._needsToStayFirst(s),a=t._isSuperCall(s);r?e.body.body.splice(0,1,t._firstNode(s),n):a?t._handleSuperCall(e.body.body):e.body.body.unshift(n)}),t._visitor.ImportBatchSpecifier.add(function(e){e.type="ImportNamespaceSpecifier",e.id=e.name,delete e.name}),t._visitor.ImportSpecifier.add(function(e){e["default"]&&(e.type="ImportDefaultSpecifier")}),t._visitor.AssignmentPattern.add(function(e){"="===e.operator&&(e.type="AssignmentExpression")})};r.prototype={instrument:function(e){var t=this;t._ranges=[],t._numberOfFunctions=0;var i,n=t._parse(e),s=t._generate(t._change(n,t._visitor));return t._opts.fullMap?i=s.map.toString():(i={},_.each(s.map._mappings._array,function(e){e.generatedLine&&e.originalLine&&(!i[e.generatedLine]||e.name)&&(i[e.generatedLine]=e.originalLine)})),{code:s.code,map:i,ranges:t._ranges,numberOfFunctions:t._numberOfFunctions,testName:t._testName}},_tryFindTestName:function(e,t){var i=this;if(i._containsChangePosition(e.body)&&t.parentContext&&!i._saveTestNameIfTestFunctionCall(t,e,t.parentNode)&&!i._tryFindTestNameFromWrappedFunction(e,t)&&t.parentContext.parentContext){var n=t.parentNode;if(_.isArray(n)&&(n[0]===e||n[1]===e)){var s=t.parentContext,r=s.parentNode;r&&"CallExpression"===r.type&&s.parentContext&&i._tryFindTestNameFromWrappedFunction(t.parentContext.parentNode,t.parentContext.parentContext)}}},_tryFindTestNameFromWrappedFunction:function(e,t){var i=this,n=t.parentNode;if(_.isArray(n)&&(n[0]===e||n[1]===e)){var s=t.parentContext,r=s.parentNode;if(r&&"CallExpression"===r.type&&s.parentContext)return i._saveTestNameIfTestFunctionCall(s.parentContext,r,s.parentContext.parentNode)}},_createVisitor:function(){var e={};return e.add=function(e,t){for(var i=0,n=e.length;n>i;i++)e[i].add(t)},_.each(["AssignmentExpression","AssignmentPattern","ArrayExpression","ArrayPattern","ArrowFunctionExpression","BlockStatement","BinaryExpression","BreakStatement","CallExpression","CatchClause","ClassBody","ClassDeclaration","ClassExpression","ComprehensionBlock","ComprehensionExpression","ConditionalExpression","ContinueStatement","DoWhileStatement","DebuggerStatement","EmptyStatement","ExportBatchSpecifier","ExportDeclaration","ExportSpecifier","ExpressionStatement","ForOfStatement","ForStatement","ForInStatement","FunctionDeclaration","FunctionExpression","GeneratorExpression","Identifier","IfStatement","ImportBatchSpecifier","ImportDeclaration","ImportSpecifier","Literal","LabeledStatement","LogicalExpression","MemberExpression","MethodDefinition","ModuleDeclaration","NewExpression","ObjectExpression","ObjectPattern","Program","Property","ReturnStatement","SequenceExpression","SpreadElement","SwitchStatement","SwitchCase","Super","TaggedTemplateExpression","TemplateElement","TemplateLiteral","ThisExpression","ThrowStatement","TryStatement","UnaryExpression","UpdateExpression","VariableDeclaration","VariableDeclarator","WhileStatement","WithStatement","YieldExpression","JSXIdentifier","JSXNamespacedName","JSXMemberExpression","JSXElement","JSXOpeningElement","JSXClosingElement","JSXEmptyExpression","JSXExpressionContainer","JSXSpreadAttribute","JSXAttribute"],function(t){var i=[];e[t]=function(e,t){for(var n=0,s=i.length;s>n;n++)i[n](e,t)};var n=e[t];n.add=function(e){i.push(e)}}),e},_change:function(e,t,i){var n,s,r=this;if(i||(i={}),e.type&&e.loc){var a=t[e.type];if(a&&t[e.type](e,i),"Identifier"===e.type||"Literal"===e.type||"ThisExpression"===e.type||"DebuggerStatement"===e.type||"EmptyStatement"===e.type||"BreakStatement"===e.type||"ContinueStatement"===e.type)return}for(var o in e)e.hasOwnProperty(o)&&"loc"!==o&&"type"!==o&&"start"!==o&&"end"!==o&&"name"!==o&&(n=e[o],n&&_.isObject(n)&&(s={parentContext:i,parentNode:e},r._change(n,t,s),s.replacement&&(e[o]=s.replacement)));return e},_parse:function(e){return n.parse(e,{locations:!0,ecmaVersion:6,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,plugins:{jsx:!0}})},_generate:function(e){return s.generate(e,{sourceMap:"original",sourceMapWithCode:!0})},_wrapInBlock:function(e){return{type:"BlockStatement",body:e}},_sequence:function(e){return{type:"SequenceExpression",expressions:e}},_literal:function(e){return{type:"Literal",value:e}},_return:function(e){return{type:"ReturnStatement",argument:e}},_firstNode:function(e){return{type:"ExpressionStatement",expression:{type:"Literal",value:e&&e.expression&&e.expression.value||""}}},_handleSuperCall:function(e){var t=this,i=e[0],n=t._instruction(i.loc,"F"),s=t._instruction(i.loc,"S");delete i.loc,delete i.expression.loc,i.expression.arguments=i.expression.arguments||[];var r=i.expression.arguments[0];r?"SpreadElement"===r.type&&r.argument?r.argument=t._sequence([n,s,r.argument]):i.expression.arguments[0]=t._sequence([n,s,r]):e.splice(1,0,{type:"ExpressionStatement",expression:t._sequence([n,s])})},_replaceConsoleLog:function(e){var t=this;e&&("CallExpression"===e.type&&e.callee&&"MemberExpression"===e.callee.type&&e.callee.object&&"Identifier"===e.callee.object.type&&"console"===e.callee.object.name&&e.callee.property&&"Identifier"===e.callee.property.type&&"log"===e.callee.property.name?(e.callee.object.name="$_$tracer",e.arguments||(e.arguments=[]),e.arguments.push(t._literal(t._opts.file)),e.arguments.push(t._literal(t._ranges.length))):e.arguments&&e.arguments.length&&t._replaceConsoleLog(e.arguments[0]))},_needsToStayFirst:function(e){return e&&"ExpressionStatement"===e.type&&e.expression&&"Literal"===e.expression.type&&("use strict"===e.expression.value||"use babel"===e.expression.value||"ngInject"===e.expression.value)},_isSystemJsModule:function(e){return e&&"ExpressionStatement"===e.type&&e.expression&&"CallExpression"===e.expression.type&&e.expression.callee&&"MemberExpression"===e.expression.callee.type&&e.expression.callee.object&&e.expression.callee.property&&"Identifier"===e.expression.callee.object.type&&"Identifier"===e.expression.callee.property.type&&"System"===e.expression.callee.object.name&&"register"===e.expression.callee.property.name&&e.expression.arguments},_isSuperCall:function(e){return e&&"ExpressionStatement"===e.type&&e.expression&&"CallExpression"===e.expression.type&&e.expression.callee&&"Super"===e.expression.callee.type},_instruction:function(e,t){var i="",n=[];switch(t){case"F":case"P":case"PE":n=[this._literal(this._opts.file)];case"FE":i=t.toLowerCase();break;default:i="",n=[this._literal(this._opts.file),this._literal(this._ranges.length)],this._ranges.push([e.start.line,e.start.column,e.end.line,e.end.column])}return{type:"CallExpression",callee:{type:"Identifier",name:"$_$w"+i},arguments:n}},_instructionStatement:function(e,t){return{type:"ExpressionStatement",expression:this._instruction(e,t)}},_saveTestNameIfTestFunctionCall:function(e,t,i){var n=this;if(_.isArray(i)&&i.length>=2&&i[1]===t&&i[0]&&"Literal"===i[0].type){var s=e.parentContext.parentNode;if(s&&"CallExpression"===s.type){var r=s.callee;if(r&&("it"===r.name||"test"===r.name||"asyncTest"===r.name||r.property&&"Identifier"===r.property.type&&("it"===r.property.name||"test"===r.property.name||"asyncTest"===r.property.name)))return n._testName=i[0].value,!0}}}},t.exports=function(e,t){return new r(t).instrument(e)}},{"acorn-jsx":void 0,"escodegen-wallaby":void 0}],11:[function(e,t,i){var n,s=e("child_process").spawn,r=e("./runWorkerPool"),a=function(t){var i=this;n=e("debug")("wallaby:nodeRunner"),i._project=t,i._nodePath=t.settings().env.runner,i._initializer=t.settings().bootstrap,i._teardown=t.settings().teardown,i._slowTestThreshold=t.settings().slowTestThreshold,i._nodeModules=t._nodeModules,i._params=t.settings().env.params,i._recycle=t.settings().workers.recycle,i._testFramework=t.settings().testFramework,i._cwd=t._instrumentedRoot,i._localProjectDir=t._localProjectDir,i._workerPool=new r(i._project,{create:_.bind(i._createNodeInstance,i),recycle:_.bind(i._recycleNodeInstance,i),healthy:_.bind(i._isNodeInstanceHealthy,i),prepare:_.bind(i._prepare,i)}),i._workerPool.setFileRoot(t._instrumentedRoot)};a.prototype={run:function(e){var t=this;return t._workerPool.run(e)},cancel:function(e){var t=this;return t._workerPool.cancel(e)},start:function(){var e=this;return e._workerPool.start()},stop:function(){var e=this;e._workerPool.stop()},_createNodeInstance:function(e,t){var i=this;setImmediate(function(){try{var r=(i._params.runner?i._params.runner.split(" "):[]).concat([process.mainModule.filename,"runner",e,i._workerPool.receiverPort(),i._testFramework.version,i._testFramework.path||"",i._nodeModules]),a={process:s(i._nodePath,r,{cwd:i._cwd,env:_.extend({},process.env,i._params.env?_.reduce(i._params.env.split(";"),function(e,t){var i=t.split("="),n=i[0];return e[n]=t.substring(n.length+1),e},{}):{})}),onConnected:function(e){_.isFunction(e)?this._onConnected=e:this._onConnected&&(this._onConnected(e),delete this._onConnected,delete this.onConnected)}};a.process.stderr.on("data",function(e){n("Error in worker: %s",e.toString("utf8"))}),t(a)}catch(o){n("Error while creating worker #%s: %s",e,o&&(o.stack||o.message)),t()}})},_recycleNodeInstance:function(e){e.process.kill()},_isNodeInstanceHealthy:function(e){return e.process&&e.process.pid&&!e.process.killed&&!e.process.signal&&null===e.process.exitCode},_prepare:function(e,t){var i=this,s=_.randomId(),r=i._sandboxName(t,s);return n("Starting sandbox [%s]",r),Q.when().then(function(){return i._workerPool.cancelled()?Q.reject({runCancelled:!0}):(n("Preparing sandbox [%s]",r),i._workerPool.getWorker(t))}).then(function(a){return n("Prepared sandbox [%s]",r),Q.when({instance:{resume:function(){a.channel.send(JSON.stringify({type:"in:tracer.resume",data:{}}))},ping:function(e){var t=function(t){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(e){var t=_.uniqueId(),i=function(e){var t=function(t){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(n){var s;try{s=JSON.parse(n)}catch(r){return}"pong"===s.type&&s.data===t&&(a.channel.removeListener("message",i),e())});a.channel.on("message",i),a.channel.send(JSON.stringify({type:"in:ping",data:t}))}),close:function(){i._recycle?(i._workerPool.recycleWorker(t),i._workerPool.getWorker(t).then(_.noop)):a.channel.send(JSON.stringify({type:"in:stop",data:{}}))},closing:_.noop,start:function(t,n){if(t("success")){a.process.stderr.removeAllListeners("data"),a.process.stderr.on("data",function(e){e=e&&e.toString("utf8"),e&&0===e.indexOf("Debugger listening on port")||n(e&&e.split("\n")[0],e)});var r={sessionId:s,tests:e.tests,files:_.map(e.allFiles.concat(e.allTestFiles),function(e){return{id:e.id,rangesLength:e.rangesLength}}),testFiles:_.map(e.testFilesToLoad,function(e){return{path:e.path,id:e.id}}),root:i._cwd,localProjectDir:i._localProjectDir,flushCache:!1,initializer:i._initializer,teardown:i._teardown,slowTestThreshold:i._slowTestThreshold};a.channel.send(JSON.stringify({type:"in:run",data:r}))}}},name:r,sessionId:s,workerId:t})})},_sandboxName:function(e,t){return"worker #"+e+", session #"+t}},t.exports=a},{"./runWorkerPool":18,child_process:void 0,debug:void 0}],12:[function(e,t,i){var n=e("path"),s=e("ws"),r=JSON.stringify,a=JSON.parse,o=process.stderr.write.bind(process.stderr),l=e("module").Module,u=l._cache,c=process.cwd(),h=[],d=e("timers").setTimeout,f=process.nextTick;e("timers").setTimeout=global.setTimeout=function(){var e=d.apply(this,arguments);return h.push(e),e};var _=function(){h.forEach(function(e){clearTimeout(e)}),h.length=0};process.on("uncaughtException",function(e){o(e&&(e.stack||e.message||e.toString())||"")});var v=function(t,i,n,r,o){var l=this;l._port=i,l._id=parseInt(t,10),l._channel=new s("ws://127.0.0.1:"+i),global.$_$receiver=l._channel,global.$_$reuseableTracer=!0,e("./tracer"),global.wallaby._frameworks={chai:{},sinon:{}},global.wallaby._localNodeModules=o,global.wallaby._testFrameworkPath=r,process.stderr.write=function(e){console.error(e)},l._testFrameworkInitializer=e("./runners/node/"+n+"/initializer.js"),l._channel.on("open",function(){l.send({worker:t})}),l._channel.on("message",function(e){e=a(e),l[e.type](e.data)})};v.prototype={send:function(e){var t=this;t._channel.send(r(e))},"in:run":function(t){var i=this;global.$_$coverage=[],Object.keys(u).forEach(function(e){var i=u[e];(i.filename&&~i.filename.indexOf(t.root)||t.flushCache)&&delete u[e]});for(var s=0,r=t.files.length;r>s;s++)for(var a=t.files[s],l=global.$_$coverage[a.id]=[],h=0;h<a.rangesLength;h++)l[h]={};global.$_$baseDir=t.root+n.sep,global.$_$slow=t.slowTestThreshold,global.$_$tests=t.tests;var d=(t.testFiles||[]).map(function(e){return e.path});global.$_$testFiles=t.testFiles,global.wallaby.tests=d,global.$_$session=t.sessionId,global.$_$initialSpecId=1e5*(i._id+1)||1,global.$_$tracer.initLoadingPhase();try{global.wallaby.testFramework=i._testFrameworkInitializer.init(d)}catch(f){o(f&&(f.stack||f.message||f.toString())||"")}global.$_$tracer.reportGlobalError=o,global.wallaby.localProjectDir=t.localProjectDir,global.wallaby.projectCacheDir=c,global.wallaby.sessionId=t.sessionId,global.wallaby.workerId=i._id;try{e("./runners/node/bootstrap")(t.initializer),global.$_$tracer.start(),i._teardown=t.teardown}catch(f){o(f&&(f.stack||f.message||f.toString())||"")}},"in:stop":function(){try{process.nextTick!==f&&(process.nextTick=f),global.$_$tracer.reset(),e("./runners/node/teardown")(this._teardown),delete this._teardown}catch(t){o(t&&(t.stack||t.message||t.toString())||"")}_(),delete global.$_$coverage,delete global.$_$tests,delete global.$_$session,delete global.$_$initialSpecId},"in:ping":function(e){this.send({type:"pong",data:e})},"in:tracer.resume":function(){global.$_$tracer.resume()}},t.exports=function(e,t,i,n,s){new v(e,t,i,n,s)}},{"./tracer":20,module:void 0,path:void 0,timers:void 0,ws:void 0}],13:[function(e,t,i){var n,s=e("phantom"),r=e("./runWorkerPool"),a=e("./browserEnvironment"),o=function(t){var i=this;n=e("debug")("wallaby:phantomRunner"),i._project=t,i._screenShotReady=Q.when(!0),i._params=t.settings().env.params,i._viewportSize=t.settings().env.viewportSize,i._clearMemoryCache=t.settings().env.clearMemoryCache,i._phantomjsPath=t.settings().env.runner||i._project._phantomjs,i._workerPool=new r(i._project,{create:_.bind(i._createPhantomInstance,i),recycle:_.bind(i._recyclePhantomInstance,i),healthy:_.bind(i._isPhantomInstanceHealthy,i),prepare:_.bind(i._prepare,i)}),i._browserEnvironment=new a(t,i._workerPool)};o.prototype={run:function(e){var t=this;return t._workerPool.run(e)},_createPhantomInstance:function(e,t){var i=this;try{var r={dnodeOpts:{weak:!1}};i._phantomjsPath&&(r.binary=i._phantomjsPath),r.onExit=function(t,i){return n("Signal killed phantomjs #%s: %s, exit code: %s",e,i,t)};var a=["--disk-cache=yes"];i._params.runner&&(a=a.concat(i._params.runner.split(" ")));var o=!1;a.push(function(s){if(!o){if(!s)return o=!0,n("Additional attempt to create phantom instance #%s",e),i._createPhantomInstance(e,t);s.set("onError",function(t){n("PhantomJs failure: %s, recycling phantom instance #%s",t,e),i._workerPool.recycleWorker(e)}),o=!0,t(s)}}),a.push(r),s.create.apply(s,a)}catch(l){n("Error while creating worker #%s: %s",e,l&&(l.stack||l.message)),t()}},_recyclePhantomInstance:function(e){e.exit(),e.process.kill()},_isPhantomInstanceHealthy:function(e){return e.process&&e.process.pid&&!e.process.killed&&!e.process.signal&&null===e.process.exitCode},_prepare:function(t,i){var s=this,r=_.randomId(),a=s._browserEnvironment.sandboxName(i,r);return n("Starting sandbox [%s]",a),Q.when().then(function(){return s._workerPool.cancelled()?Q.reject({runCancelled:!0}):(n("Preparing sandbox [%s]",a),Q.all([s._getPage(i),s._browserEnvironment.prepareSandbox(t,r,i)]))}).then(function(o){n("Prepared sandbox [%s]",a);var l=o[0],u=o[1];return Q.when({instance:{resume:function(){l.evaluate(function(){$_$tracer.resume()})},ping:function(e){l.evaluate(function(){},e)},close:function(){l.stop&&l.stop(),l.close()},closing:function(){s._captureScreenShot(t.screen,l)},start:function(i,n){s._clearMemoryCache&&l.onResourceRequested(function(t,i,n){try{var s=global._urlUtil=global._urlUtil||e("url"),r=t.url;if(!r)return;if(0===r.indexOf("data:"))return;if(~r.indexOf("wallabyFileId"))return;var a=s.parse(t.url),o="/"===a.pathname.charAt(0)?a.pathname.substr(1):a.pathname,u=o&&n[o];if(!u)return;var c=a.search&&a.search.length;i.changeUrl(r+(c?"&":"?")+u.ts+"&wallabyFileId="+u.id),l.clearMemoryCache()}catch(h){console.log(h&&h.message)}},_.noop,t.allFilesHash),l.set("onError",n),l.open(u,function(e){i(e)&&l.evaluate(function(){$_$tracer.start()})})}},name:a,sessionId:r,workerId:i})})},cancel:function(e){var t=this;return t._workerPool.cancel(e)},start:function(){var e=this;return e._workerPool.start(e._browserEnvironment.webApp())},stop:function(){var e=this;e._workerPool.stop()},_captureScreenShot:function(e,t){var i=this,n=Q.defer();try{t.render(e,function(){n.resolve()}),i._screenShotReady=n.promise}catch(s){n.reject(new Error("Failed to render test run screen shot")),console.error("Failed to render test run screen shot",s.message)}},_getPage:function(e){var t=this;return t._workerPool.getWorker(e).then(function(i){return t._workerPool.cancelled()?Q.reject({runCancelled:!0}):(n("Creating page for worker #"+e),t._createPage(i,e))})},_createPage:function(e,t){var i=this;return Q.promise(function(s,r){var a=!1,o=setTimeout(function(){a||(l(),i._workerPool.recycleWorker(t),n("Phantom page is not created in time, recycling it"),r({runCancelled:!0,rerun:!0}))},400),l=function(){a=!0,clearTimeout(o)};try{e.createPage(function(e){a||(l(),n("Phantom page created"),e.set("viewportSize",i._viewportSize||{width:800,height:600}),s(e))})}catch(u){l(),r(u)}})}},t.exports=o},{"./browserEnvironment":3,
"./runWorkerPool":18,debug:void 0,phantom:void 0,url:void 0}],14:[function(e,t,i){"use strict";var n=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(t,i,n){s(this,e),this.type=t.type,this.path=t.path,this.content=i,this.maps=[],this.config=n}return n(e,{rename:{value:function(e){return this.newPath=e,this}},changeExt:{value:function(e){var t=this.newPath||this.path;return this.newPath=t.substr(0,t.lastIndexOf(".")+1)+e,this}}}),e}();t.exports=r},{}],15:[function(e,t,i){function n(e){this.process=r.fork(e,["worker"]),this.pid=this.process.pid,this.status=WorkerState.STARTING,this.process.once("message",this.onReady.bind(this)),a.EventEmitter.call(this)}function s(e,t){function i(){var t=new n(e);t.on("ready",s._run.bind(s)),t.process.on("exit",function(e){if(0!==e){for(var n=0;n<s.workers.length;n++)s.workers[n].pid===t.pid&&s.workers.splice(n,1);i()}}),s.workers.push(t)}this.workers=[],this.queue=[];var s=this;t=t||o.cpus().length;for(var r=0;t>r;r++)i()}var r=e("child_process"),a=e("events"),o=e("os"),l=e("util");WorkerState={STARTING:"STARTING",READY:"READY",BUSY:"BUSY"},l.inherits(n,a.EventEmitter),n.prototype.onReady=function(){this.status===WorkerState.STARTING&&(this.status=WorkerState.READY,this.emit("ready",this))},n.prototype.onMessage=function(e,t){e(t),this.status=WorkerState.READY,this.emit("ready",this)},n.prototype.send=function(e,t){this.status=WorkerState.BUSY,this.emit("busy"),this.process.once("message",this.onMessage.bind(this,t)),this.process.send(e)},s.prototype.enqueue=function(e,t){this.queue.push({task:e,callback:t}),process.nextTick(this._run.bind(this))},s.prototype.stop=function(){_.each(this.workers,function(e){e.process.send({type:"exit"})})},s.prototype._run=function(e){if(0!==this.queue.length){if(!e)for(var t=0;t<this.workers.length;t++)if(this.workers[t].status===WorkerState.READY){e=this.workers[t];break}if(e){var i=this.queue.shift();e.send(i.task,i.callback)}}},t.exports={_queue:void 0,start:function(e){this._queue||(this._queue=new s(e))},run:function(e){var t=this;return t._queue?Q.promise(function(i,n){try{t._queue.enqueue(e,function(e){i(e)})}catch(s){n(s)}}):Q.reject(new Error("Processor pool is not started"))},stop:function(){this._queue&&(this._queue.stop(),delete this._queue)}}},{child_process:void 0,events:void 0,os:void 0,util:void 0}],16:[function(e,t,i){"use strict";var n,s=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=e("minimatch"),o=e("./config"),l=e("./preprocessedFile"),u="Processor must pass a string, an object with code property or an error to done function.",c="Processor must be an async function with two params, where last param is done callback, or sync function with one param and returning the result.",h=function(){function t(i,s){r(this,t),this._config=i,this._root=s,n=e("debug")("wallaby:processor")}return s(t,{run:{value:function(e,t,i){var s=this;return o(this._config,this._root).then(function(r){var a=s._processors(r,t,i);if(!a.length)return n("No %s found for %s",i?"compilers":"preprocessors",t.path),Q.when({content:e,noProcessors:!0});i&&(a=[a[0]]);var o=Q.when(new l(t,e,r));return n("Running %s processor(s) for %s",a.length,t.path),a.forEach(function(e){o=o.then(function(i){return Q.promise(function(s,r){try{var a=function(e){n("Finished running one processor for %s",t.path);var a;if(e instanceof Error)return void r(e);if(_.isObject(e)){if(!_.isString(e.code))return void r(new Error(u));a=e.code;var o=e.map||e.sourceMap;o&&i.maps.push(o),e.ranges&&(i.ranges=e.ranges)}else{if(!_.isString(e))return void r(new Error(u));a=e}i.content=a,s(i)};if(1===e.length){var o=void 0;try{o=e(i)}catch(l){o=l}finally{a(o)}}else 2===e.length?e(i,a):r(new Error(c))}catch(h){r(h)}})})}),o})}},_processors:{value:function(e,t,i){var n=[],s=i?e.compilers:e.preprocessors;return _.each(s,function(e,i){if(!_.isString(i))throw new Error("Processor patterns object keys must be strings.");if(!_.isArray(e)&&!_.isFunction(e))throw new Error('Processor(s) for "'+i+'" is specified incorrectly, must be an array of functions or a function.');_.isFunction(e)&&(e=[e]),a(t.path,i)&&(n=n.concat(_.map(e,function(e){if(!_.isFunction(e))throw new Error('Processor for "'+i+'" is specified incorrectly, must be an array of functions or a function.');return e})))}),n}}}),t}();t.exports=function(e){return new h(e.config,e.root).run(e.content,e.file,"compiler"===e.type)}},{"./config":5,"./preprocessedFile":14,debug:void 0,minimatch:void 0}],17:[function(e,t,i){var n,s=e("path"),r=(e("module").Module,e("./config")),a=e("./instrumentor"),o=e("./processor"),l=e("./testTask").TestTask,u=e("./tracking"),c=e("./testTask").runPriority,h=e("minimatch"),d=e("source-map").SourceMapConsumer,f=e("child_process"),v=f.spawn,p={};f.spawn=function(){"cmd"===arguments[0]&&arguments[1]&&arguments[1].length>=3&&"/d"===arguments[1][0]&&"/c"===arguments[1][1]&&(arguments[0]=arguments[1][2],arguments[1].splice(0,3));var e=v.apply(this,arguments);try{var t=e.pid;e.on("exit",function(){t&&delete p[t]}),p[t]=e}catch(i){}return e};var g="^#^",m=1,y=2,b=function(t){var i=this;i._structureFileFormatVersion=8,i._wallabyEmail="wallabyjs@gmail.com",i._diffMatchPatch=t.diffMatchPatch,i._processorPool=t.processorPool,i._runnerResolver=t.runnerResolver,i._fileStructureCachePromise=t.fileStructureCachePromise,i._fileStatPromise=t.fileStatPromise,i._readFilePromise=t.readFilePromise,i._writeFilePromise=t.writeFilePromise,i._unlinkFilePromise=t.unlinkFilePromise,i._unlinkFileSync=t.unlinkFileSync,i._readFileSync=t.readFileSync,i._writeFileSync=t.writeFileSync,i._fileExistsSync=t.fileExistsSync,i._dirRemovePromise=t.dirRemovePromise,i._dirRemoveSync=t.dirRemoveSync,i._dirEnsurePromise=t.dirEnsurePromise,i._dirEnsureSync=t.dirEnsureSync,i._lruCache=e("lru-cache")({max:52428800,length:function(e){return e.length}}),i._root=t.projectCachePath,i._configFile=t.configPath,i._localRoot=s.dirname(i._configFile),i._phantomjs=t.phantomjs;var n=s.join(i._localRoot,"node_modules");i._nodeModules=i._fileExistsSync(n)?n:void 0,i._packageJson=s.join(i._localRoot,"package.json"),i._babelrc=s.join(i._localRoot,".babelrc"),i._localProjectDir=i._localRoot+s.sep,i._originalRoot=s.join(i._root,"original"),i._instrumentedRoot=s.join(i._root,"instrumented");var r=s.join(i._instrumentedRoot,"node_modules");i._screenPath=s.join(i._instrumentedRoot,"screen.png"),i._structureFile="structure.json",i._nodeModules&&t.nodeModulesLookup(function(e){e.push(n)},function(e){return e.replace(r,n)}),i._live=!1,i._sourceFileCache={},i._changeQueue={},i._testTask=new l(i),i._tracker=new u(t,i._root),i._init=t._init,i._coreVersion=t.coreVersion};b.prototype=_.extend(Object.create(EventEmitter.prototype),{configure:function(e){var t=function(){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(){var t=this;return r(t._configFile,t._instrumentedRoot,t._forceConfigUpdate).then(function(i){t._settings=i,t._settings&&t._settings.debug&&(process.env.DEBUG="wallaby:.*",process.env.DEBUG_FD=1),n=e("debug")("wallaby:project"),_.isArray(i.postprocessor)&&(i.postprocessor=t._configureComplexPostprocessor(i.postprocessor)),i.configCode=t._readFileSync(t._configFile);var s=i.files.length;t._emit({type:"projectConfigured",browser:"browser"===i.env.type,editDelay:i.delays.edit,files:_.map(i.files.concat(i.tests),function(e,t){return t>=s&&(e.test=!0),e})})}).fail(function(e){t._cleanStack(e,t._configFile),console.error("Failed to load configuration file: ",e&&(e.stack||e.message)),t._emitTestRunError(e&&(e.stack||e.message))})}),_configureComplexPostprocessor:function(e){var t=this;if(2!=e.length)throw new Error("Only TypeScript postprocessor chaining is supported");var i=e[0],s=e[1];return function(e){return _.each(e.affectedFiles,function(e){var i=t._structure.filesById[e.id];i&&t._deleteDependantFilesMetadata(i)}),i(e).then(function(i){if(i.removePostprocessor)t._settings.postprocessor=s,n("TypeScript postprocessor is removed as requested by itself");else{var r=function(e){var i=t._createPostProcessorInputFile(e);return e.originalId&&(i.id=e.originalId),i},a=function(e){return e&&_.isEmpty(e.dependant)&&(!e.tmp||e.originalId)},o=function(e){var i=t._structure.filesById[e.id];return i&&!_.isEmpty(i.dependant)?_.values(i.dependant)[0]:i};t._updateFileOrder();var l=_.chain(t._structure.testFilesInOrder).filter(a).map(r).value(),u=_.chain(t._structure.sourceFilesInOrder).filter(a).map(r).value().concat(l),c=_.chain(e.affectedFiles).map(o).filter(a).map(r).value(),h=_.chain(e.affectedTestFiles).map(o).filter(a).map(r).value();e=_.extend(e,{allTestFiles:l,allFiles:u,affectedFiles:c,affectedTestFiles:h})}return s(e)})}},configFilePath:function(){return this._configFile},coreVersion:function(){return this._coreVersion},projectName:function(){return this._settings.name||s.basename(this._localRoot)},start:function(e){var t=this,i=t._init(e,t);return t._emitInternal({type:"starting",files:e.files}),i.then(function(){return t._live&&t.stop(),Q.when(!0)}).then(function(){return n("File cache: %s",t._root),t._live=!1,Q.all([t._dirEnsurePromise(t._originalRoot),t._dirEnsurePromise(t._instrumentedRoot)])}).fail(function(e){return t._cleanStack(e),t._emitTestRunError(e.stack||e.message),Q.reject({error:e})}).then(function(){return t._fileStructureCachePromise(s.join(t._root,t._structureFile))}).fail(function(e){return e&&e.error?Q.reject(e.error):Q.when({})}).then(function(e){var i=function(){return t._dirRemovePromise(t._instrumentedRoot).then(function(){return t._dirEnsurePromise(t._instrumentedRoot)})};return Q.all([t._fileStatPromise(t._packageJson).then(function(e){return Q.when(e.mtime.getTime())}).fail(function(){return Q.when(0)}),t._fileStatPromise(t._babelrc).then(function(e){return Q.when(e.mtime.getTime())}).fail(function(){return Q.when(0)})]).then(function(s){var r=s[0],a=s[1];return e.invalidateCache?(n("Invalidating local cache as requested"),i().then(function(){return Q.when({packageJsonTimestamp:r,babelrcTimestamp:a})})):r!==e.packageJsonTimestamp?(n("package.json file change detected, invalidating local cache"),i().then(function(){return Q.when({packageJsonTimestamp:r,babelrcTimestamp:a})})):a!==e.babelrcTimestamp?(n(".babelrc file change detected, invalidating local cache"),i().then(function(){return Q.when({packageJsonTimestamp:r,babelrcTimestamp:a})})):e.configCode!==t._settings.configCode||t._structureFileFormatVersion!==e.version?(n("Config file change detected, invalidating local cache"),i().then(function(){return Q.when({packageJsonTimestamp:r,babelrcTimestamp:a})})):(e.packageJsonTimestamp=r,e.babelrcTimestamp=a,Q.when(e))})}).then(function(i){t._structure=_.extend({filesByPath:{},filesRenamed:{},filesById:{},testFilesById:{},awaitingFiles:[],configCode:t._settings.configCode},i),t._structure.awaitingFiles=[],t._structure.sourceFilesInOrder=[],t._structure.testFilesInOrder=[];var s=_.reduce(e.files,function(e,t){return e[t.path]=!0,e},{});_.each(t._structure.filesByPath,function(e){if(!s[e.path]){var i=t._deleteFileMetadata(e);i&&(t._unlinkFilePromise(i.originalPath),t._unlinkFilePromise(i.instrumentedPath))}});var r=[],a=!1;_.each(e.files,function(e){var i=e.path;if(e.test||_.find(t._settings.tests,function(t){return t.ignore&&h(e.path,t.pattern)}))a=!0;else{var s=_.find(t._settings.tests,function(t){return!t.ignore&&h(e.path,t.pattern)});s&&console.error("File/pattern "+e.path+" is specified in the files list but also found in the tests list: "+s.pattern+".\r\n	If it's a test, make sure to exclude it from the files list, for example by adding { pattern: '"+s.pattern+"', ignore: true } to the files list.\r\n	If it's not a test, remove it from the tests list.")}var o=t._structure.filesByPath[i],l=o&&o.id===e.id,u=!1;o?(o=t._createFileMetadata(o,e.id),e.order&&(o.order=e.order),o.ts!==e.ts&&(t._structure.awaitingFiles.push(e.id),u=!0)):(o=t._createFileMetadata(e,e.id),t._structure.awaitingFiles.push(e.id),u=!0),u||r.push(t._readFilePromise(o.originalPath).fail(function(){return n("No cached file "+e.path+", requesting it from IDE"),t._structure.awaitingFiles.push(e.id),Q.when(!1)}).then(function(i){return i===!1?Q.when(!1):l?t._readFilePromise(o.instrumentedPath).fail(function(){return n("No instrumented file "+e.path+", re-instrumenting original file"),t._processFile(o,i,void 0,!0,!1)}):(n("Re-instrumenting original file because its ID has changed"),t._processFile(o,i,void 0,!0,!1))}))}),a||console.error("No files with tests found, check your tests list patterns."),t._fileOrderUpdatePending=!0;var o=t._runnerResolver(t._settings.env.type,t._settings.env.kind);return t._testRunner=new o(t),Q.all(r.concat([t._testRunner.start()]))}).fail(function(e){return t._signalIfBecameLive(),t._emitTestRunError(e.message),t._cleanStack(e),Q.reject(e)}).then(function(){t._signalIfBecameLive()?(n("File cache is up-to-date, starting full test run"),t._queueTestRunFromFileChanges(null,!0),t._scheduleTestRun()):(n("File cache requires some updates, waiting required files from IDE"),t._emit({type:"filesRequired",files:t._structure.awaitingFiles}))})},file:function(e){var t=this;return t._emitInternal({type:"file",file:e.file,"delete":e["delete"]}),Q.promise(function(i,n){try{t._tryCancelActiveTestRun(c.fileChangePriority),t._queueFileChange(e),t._scheduleChangedQueueProcessing(),i()}catch(s){n(s)}})},runTests:function(e){var t=this;t._tryCancelActiveTestRun(c.testRunPriority),e.tests?t._queueRequestedTestRun(e.tests):t._queueFullTestRun(),t._scheduleTestRun()},screen:function(e){var t=this;return t._settings&&"browser"===t._settings.env.type?t._testRunner._screenShotReady.then(function(){return t._readFilePromise(t._screenPath)}).fail(function(){return n("Unable to load test run screen shot"),Q.when(!1)}).then(function(i){i&&t._emit({type:"screen",screen:new Buffer(i).toString("base64")},e)}):Q.when(!1)},stop:function(){var e=this;if(e._live=!1,e._tracker.dispose(),n=n||_.noop,n("Stopping wallaby.js"),n("Killing %s spawned process(es)",_.keys(p).length),_.each(p,function(e){try{e.kill()}catch(t){}}),e._multicaster&&e._multicaster.stop(),e._flushSourceFileCacheSync(),e._uiService&&e._uiService.stop(),n("Stopping test runner"),e._testRunner&&e._testRunner.stop(),e._structure){var t={version:e._structureFileFormatVersion,filesByPath:e._structure.filesByPath,configCode:e._structure.configCode,packageJsonTimestamp:e._structure.packageJsonTimestamp,babelrcTimestamp:e._structure.babelrcTimestamp,invalidateCache:e._invalidateCache};_.each(t.filesByPath,function(i,n){delete i.changeTs,delete i.changeStart,delete i.changePosition,delete i.numberOfFunctionsChanged,delete i.lastChangeIsComplex,delete i.lastSingleChangeTest,delete i.dependant,delete i.tmpLineMap,delete i.noCompilers,delete i.noPreprocessors,delete i.sourceMap,delete i.testFilesLoadedFrom,delete i.tests,i.tmp&&(delete t.filesByPath[n],e._unlinkFileSync(i.instrumentedPath))});var i=JSON.stringify(t);n("Saving file structure"),e._writeFileSync(s.join(e._root,e._structureFile),i)}},idByPath:function(e){var t=this._structure.filesByPath[e];if(t)return t.id},invalidateCache:function(){this._invalidateCache=!0},settings:function(){return this._settings},_cleanStack:function(e,t){if(e){if(t){if(e.stack&&_.isString(e.stack)){var i=s.basename(t),n=e.stack.toString().match(new RegExp("[\\s\\S]*"+i.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+"[^\\)]*\\)","i"));n&&n[0]?e.stack=n[0]:e.stack=""}}else if(e.stack&&_.isString(e.stack)){var r=s.dirname(process.mainModule.filename);e.stack=this._cleanMessage(_.filter(e.stack.split("\n"),function(e,t){return!t||!_.contains(e,r)&&!_.contains(e,"From previous event:")}).join("\n"))}else e.stack="";return e}},_cleanMessage:function(e){return e&&_.isString(e)?e.replace(this._instrumentedRoot,"."):e},_startProcessorPool:function(){var e=this;n("Starting processor pool (if not yet started)"),e._processorPool.start(process.mainModule.filename)},_tryCancelActiveTestRun:function(e){var t=this;t._runCancelRequester=e;var i=t._testRunner&&t._testRunner.cancel(e);i?n("Test run was cancelled"):i===!1&&n("Test run is not cancelled because cancel requester does not have enough priority to cancel the run")},_originalLineByFileId:function(e,t){var i=this,n=i._structure.filesById[e];return n&&n.getFileLineMap()?n.getFileLineMap()[t]||t:t},_originalLineByFilePath:function(e,t){var i=this,n=i._structure.filesByPath[e];return n&&n.getFileLineMap()?n.getFileLineMap()[t]||t:t},stackEntryByFileId:function(e,t){var i=this,n={file:e};return n.line=i._originalLineByFileId(n.file,t),n},stackEntryByFilePath:function(e,t){var i=this,n=i._structure.filesByPath[e]||i._structure.filesByPath[i._structure.filesRenamed[e]||""];if(n&&(!n.tmp||(n=i._structure.filesById[n.originalId]))){e=n.path;var s={file:n.id};return s.line=i._originalLineByFilePath(e,t),s}},_emit:function(e,t){t&&t.id&&(e.id=t.id),this.emit("message",e)},_emitInternal:function(e,t){e._internal=!0,this._emit(e,t)},_isJavaScript:function(e){var t=this;return this._isOriginallyJavaScript(e)||"js"===e.instrumentedType||"jsx"===e.instrumentedType||"es6"===e.instrumentedType||_.find(e.dependant,function(e){return t._isJavaScript(e)})},_isOriginallyJavaScript:function(e){return"js"===e.type||"jsx"===e.type||"es6"===e.type},_isOriginallyCoffeeScript:function(e){return"coffee"===e.type||/\.(litcoffee|coffee\.md)$/.test(e.originalPath)},_isOriginallyTypeScript:function(e){return"ts"===e.type},_runTests:function(e){var t=this,i=e.isFullRun(),s=e.isFileChangedRun(),r=e.files(),a=e.testData(),o=a&&a.files,l=a&&a.names,u=e.getPriority();if(i&&n("Running all tests"),s&&o&&_.isEmpty(o)&&!_.find(r,function(e){return t._isJavaScript(e)}))return Q.when({queueAgain:!0});t._updateFileOrder();var c=t._structure.sourceFilesInOrder,h=o?t._orderFilesByConfig(t._expandDependantFiles(o)):t._structure.testFilesInOrder,d=_.find(c.concat(h),function(e){return t._isJavaScript(e)&&!e.validSyntax&&e.coverable});if(d)return Q.when({queueAgain:!0,file:d.path});var f=t._selectRunnerFiles(h),v=t._selectRunnerFiles(c);if(!f.length&&r){var p=_.map(r,function(e){return e.id});_.isEqual(p,t._lastChangedFileIds)||(t._lastChangedFileIds=p),t._settings.loose?console.log("Can't determine tests to run for the change, try re-running all tests.\nTo perform a full test run when can not determine tests to run, remove the `loose` configuration option."):(console.log("Can't determine tests to run for the change, re-running all tests.\nTo prevent the full test run when can not determine tests to run, use `loose: true` configuration option."),f=t._selectRunnerFiles(t._structure.testFilesInOrder),l=void 0,i=!0,u=e.getFullRunPriority(),n("Test task priority upgraded to full run"))}else delete t._lastChangedFileIds;return t._testRunner.run({framework:t._settings.testFramework,fullRun:i,screen:t._screenPath,filesToLoad:_.filter(v,function(e){return e.include}),allFiles:v,testFilesToLoad:_.filter(f,function(e){return e.include}),allTestFiles:f,tests:l,priority:u}).then(function(e){return _.each(r,function(e){delete e.testFilesLoadedFrom}),e.testFiles=_.filter(f,function(e){return!e.tmp}),Q.when(e)})},_expandDependantFiles:function(e){return _.each(e,function(t){_.extend(e,t.dependant||{})}),e},_selectRunnerFiles:function(e){var t=this;return _.map(e,function(e){var i=s.relative(t._instrumentedRoot,e.instrumentedPath);return{path:e.instrumentedPath,relativePath:i,normalizedRelativePath:t.normalizePath(i),ts:e.changeTs,id:e.id,tmp:e.tmp,originalId:e.originalId,include:e.include,type:e.instrumentedType||e.type,rangesLength:e.ranges&&e.ranges.length||0,shadowed:!_.isEmpty(e.dependant)}})},_queueFileChange:function(e){var t=this;if(!e.file)throw new Error("File is missing");var i=e.file.id;if(!i)throw new Error("File id is missing");var n=t._changeQueue[i]=t._changeQueue[i]||[];n.push(e)},_emitBusy:function(){this._emit({type:"busy"}),this._tracker.busy()},_scheduleChangedQueueProcessing:function(){var e=this;e._emitBusy(),e._changedQueueTimeout&&clearTimeout(e._changedQueueTimeout),e._changedQueueTimeout=setTimeout(function(){if(e._fileChangesInProcess||e._testRunInProgress||!e._structure)return void e._scheduleChangedQueueProcessing();e._emitBusy(),delete e._changedQueueTimeout,e._fileChangesInProcess=!0;var t=!e._live;e._processChangedQueue().then(function(i){e._fileChangesInProcess=!1,i.length&&_.find(i,function(e){return e.file.triggersTests})?(e._queueTestRunFromFileChanges(i,t&&e._live),!e._pendingChanges()&&e._live&&e._scheduleTestRun()):n("Changes did not trigger any tests")}).fail(function(t){n("Test queueing failure: "+t&&(t.stack||t.message)),e._cleanStack(t),e._emitTestRunError(t&&t.message)})},e._settings.delays.update)},_pendingChanges:function(){return!_.isEmpty(this._changeQueue)},_queueTestRunFromFileChanges:function(e,t){var i=this;if(t)i._queueFullTestRun();else if(!i._testTask.isFullRun()){i._testTask.setFileChangeRunPriority();var n=!1,s=!1;_.each(e,function(e){n=n||e.added,s=s||e.deleted;var t=e.file;e.deleted?i._testTask.addTests(e.tests):i._testTask.addChangedFile(t,e.tests)}),n&&i._testTask.filesAdded(),s&&i._testTask.filesDeleted()}},_queueRequestedTestRun:function(e){var t=this;t._testTask.addTests(e),t._testTask.setTestRunPriority()},_queueFullTestRun:function(){var e=this;e._testTask=new l(e),e._testTask.setFullRunPriority()},_scheduleTestRun:function(){var e=this;e._emitBusy(),e._testRunTimeout&&clearTimeout(e._testRunTimeout),e._testRunTimeout=setTimeout(function(){if(e._fileChangesInProcess||e._testRunInProgress)return void e._scheduleTestRun();e._emitBusy(),delete e._testRunTimeout,delete e._runCancelRequester,e._testRunInProgress=!0;var t=e._testTask;e._testTask=new l(e),t&&t.anyFilesAdded()&&e._removedPostprocessor&&!e._settings.postprocessor&&_.find(t.files(),function(t){return e._isOriginallyTypeScript(t)})&&(n("TypeScript file has been added, re-activating TypeScript postprocessor"),e._settings.postprocessor=e._removedPostprocessor,delete e._removedPostprocessor);var i=[];(e._settings.postprocessor?Q.promise(function(s,r){try{n("Running postprocessor");var a=t.testData(),o=e._createPostProcessorArgument({affectedFiles:_.values(t.files()),affectedTestFiles:a&&a.files,anyFilesAdded:t.anyFilesAdded(),anyFilesDeleted:t.anyFilesDeleted(),logger:{error:function(t){var n={stack:t};e._cleanStack(n),i.push({message:n.stack})}}});(o.anyFilesAdded||o.anyFilesDeleted)&&e._deleteTmpFiles(),s(e._settings.postprocessor(o)["catch"](function(e){return Q.reject(e)}))}catch(l){r(l)}}).fail(function(i){return e._runCancelRequester>=t.getPriority()?Q.reject({runCancelled:!0}):(n("Postprocessor run failure: "+i&&(i.stack||i.message)),i.postprocessor=!0,Q.reject(i))}).then(function(i){return e._runCancelRequester>=t.getPriority()?Q.reject({runCancelled:!0}):(n("Postprocessor execution finished"),i&&i.removePostprocessor&&(n("Postprocessor is removed as requested by itself"),e._removedPostprocessor=e._settings.postprocessor,delete e._settings.postprocessor),Q.when(!0))}):Q.when(!0)).then(function(){return n("Test run started; run priority: %s",t.getPriority()),e._runTests(t)}).fail(function(t){return t.runCancelled?(n("Test run cancelled, re-queueing run data"),Q.when({queueAgain:!0,rerun:t.rerun})):t.postprocessor?(e._emitTestRunError("Postprocessor run failure: "+(t&&t.message)),Q.when({queueAgain:!0})):(e._emitTestRunError("Test run failure: "+(t&&t.message)),Q.when(!1))}).then(function(s){if(n("Test run finished"),delete e._runCancelRequester,e._testRunInProgress=!1,s)if(i.length&&(s.globalErrors=(s.globalErrors||[]).concat(i)),s.queueAgain)s.file&&(n("File has invalid syntax: "+s.file),e._emitTestRunError("Test run failure: file "+s.file+" has invalid syntax")),(!s.file||t.hasFiles())&&(e._testTask.mergeTask(t),n("Test run data re-queued"),e._emit({type:"testRunReQueued"})),s.rerun&&e._scheduleTestRun();else{var r=s.globalErrors&&s.globalErrors.length,a=r||e._hadGlobalErrorsPreviousRun;e._hadGlobalErrorsPreviousRun=r,r&&s.testFiles&&(e._lastAffectedTestFileIds=_.map(s.testFiles,function(e){return e.id})),s.changed=t.isFullRun()?!0:_.reduce(t.files(),function(e,t){var i=!!t.lastSingleChangeTest;return delete t.lastSingleChangeTest,e[t.id]={singleTestChange:!a&&i},e},{}),e._emit(e._processCoverageResult({type:"testResults",fullRun:t.isFullRun()},s)),n("Test run result processed and sent to IDE")}}).fail(function(e){n("Failed to process test run results",e.stack),console.error("Failed to process test run results",e.message)})},e._settings.delays.run)},hadGlobalErrorsPreviousRun:function(){return this._hadGlobalErrorsPreviousRun},_emitTestRunError:function(e){var t=this;t._emit({type:"testRunError",message:t._cleanMessage(e)})},_deleteDependantFiles:function(e,t){var i=this;return t||(t=[]),_.each(e.dependant,function(e){t.push(i._unlinkFilePromise(e.instrumentedPath).fail(function(){return Q.when()})),i._deleteDependantFiles(e,t)}),t},_processChangedQueue:function(){var e=this,t=[],i=[];_.each(e._changeQueue,function(n,s){s=parseInt(s,10);var r=!1,a=!1,o=e._structure.filesById[s],l=[],u=[];if(_.each(n,function(e){return e["delete"]?void(r=e):(l.push(e),u=u.concat(e.file.affectedTests||[]),void(a=e.file.test||o&&o.test))}),u.length||a&&r||(u=a?[[s]]:o&&_.map(o.tests,function(e,t){return e===y&&delete o.tests[t],t.split(g)})||[]),a&&(e._lastAffectedTestFileIds=r?void 0:[s]),r){var c=e._structure.filesByPath[r.file.path];if(c){if(t=t.concat(e._deleteDependantFiles(c)),e._deleteFileMetadata(r.file),a){var h=c.path;_.each(e._structure.filesById,function(e){_.each(e.tests,function(t){(t===h||_.startsWith(t,h+g))&&delete e.tests[t]})})}t.push(e._deleteSourceFile(c.originalPath)),t.push(e._unlinkFilePromise(c.instrumentedPath)),i.push({file:c,deleted:!0,tests:c.test?[]:u})}}else if(l.length){var d=_.last(l),f=e._getOrCreateFileMetadata(d.file);t.push(e._writeFileChanges(f,_.map(l,function(e){return e.file.content}),d.file.ts)),i.push({file:f,tests:u,added:!o})}}),e._changeQueue={};var s=function(){e._filesAreUpToDate(_.map(i,function(e){return e.file.id}))};return Q.all(t).then(function(){return s(),Q.when(i)}).fail(function(t){return n("File system update failure: "+t&&(t.stack||t.message)),s(),e._cleanStack(t),e._emitTestRunError(t&&t.message),Q.when([])})},normalizePath:function(e){return e?e.split(s.sep).join("/"):e},_createPostProcessorArgument:function(e){var t=this;e=e||{};var i=t._createPostProcessorInputFile.bind(t),n=function(e){return!e.tmp};t._updateFileOrder();var r=_.chain(t._structure.testFilesInOrder).filter(n).map(i).value(),a=_.chain(t._structure.sourceFilesInOrder).filter(n).map(i).value().concat(r),o=e.affectedFiles&&e.affectedFiles.length&&_.chain(e.affectedFiles).filter(n).map(i).value()||a,l=e.affectedTestFiles&&e.affectedTestFiles.length&&_.chain(e.affectedTestFiles).filter(n).map(i).value()||r;return delete e.affectedFiles,delete e.affectedTestFiles,_.extend({},{anyFilesAdded:!0,anyFilesDeleted:!1,allFiles:a,allTestFiles:r,affectedFiles:o,affectedTestFiles:l,nodeModulesDir:t._nodeModules,baseDir:t._instrumentedRoot,setFileOrder:function(e){if(e.file&&e.file.id){t._fileOrderUpdatePending=!0;var i=t._getFileMetadataById(e.file.id);i&&(i.order=e.order)}return Q.when(e.order)},createFile:function(e){var i=_.ltrim(s.extname(e.path),"."),n=t.normalizePath(e.path),r=_.extend(e,{id:n,path:n,ts:e.ts||+new Date,tmp:!0,type:i,instrumentedType:i,include:e.load!==!1,order:e.order||0,test:e.test||e.test!==!1&&e.original&&e.original.test}),a=t._createFileMetadata(r,r.id);t._fileOrderUpdatePending=!0;var o=e.original&&e.original.id&&e.ranges&&e.sourceMap;if(e.original&&e.original.id){var l=t._structure.filesById[e.original.id];a.originalId=l.id,a.ranges=l.ranges,delete l.dependant[a.id];var u=_.values(l.dependant)[0];u&&(u.noCompilers===!1?t._deleteFileMetadata(u):u=void 0),l.dependant[a.id]=a,e.sourceMap&&!o&&(l.tmpLineMap=t._updateFileMap(u&&l.tmpLineMap||l.lineMap,[e.sourceMap])),o&&(a.noCompilers=!1,a.sourceMap=e.sourceMap,a.ranges=e.ranges,a.type="js",a.lineMap=t._updateFileMap(a.lineMap,[e.sourceMap]),a.coverable=l.coverable,a.numberOfFunctions=l.numberOfFunctions,a.changePosition=_.textIndexPosition(t._getInstrumentedFileContent(l),l.changeStart))}return o?t._processFile(a,e.content,void 0,!1,!0).then(function(e){return l.tmpLineMap=a.lineMap,l.ranges=a.ranges,l.validSyntax=a.validSyntax,l.include=!1,l.numberOfFunctionsChanged=a.numberOfFunctionsChanged,l.numberOfFunctions=a.numberOfFunctions,l.lastSingleChangeTest=a.lastSingleChangeTest,delete a.lineMap,Q.when(e)}):t._doWriteFileWithLruCache(a.instrumentedPath,e.content)}},e,{logger:t._createLogger("postprocessor",e.logger)})},_createLogger:function(t,i){return i=i||{},{debug:e("debug")("wallaby:"+t),error:i.error||console.error.bind(console),log:i.log||console.log.bind(console)}},_createPostProcessorInputFile:function(e){var t=this;return{path:t.normalizePath(s.relative(t._instrumentedRoot,e.instrumentedPath)),fullPath:e.instrumentedPath,binary:e.binary,ts:e.changeTs,id:e.id,type:e.instrumentedType||e.type,load:e.include,initialLoad:e.initialInclude,instrument:e.coverable,test:e.test,order:e.order,getContent:function(){var i=t._lruCache.get(e.instrumentedPath);return i?Q.when(i):t._readFilePromise(e.instrumentedPath)},getContentSync:function(){return t._getInstrumentedFileContent(e)},setOrder:function(i,n){t._fileOrderUpdatePending=!0,n&&_.each(e.dependant,function(e){e.order=i}),e.order=i}}},_getInstrumentedFileContent:function(e){var t=this,i=t._lruCache.get(e.instrumentedPath);return i||t._readFileSync(e.instrumentedPath)},findTestFile:function(e){var t=this;e=e||[];for(var i=0,n=e.length;n>i;i++){var s=e[i],r=t._structure.testFilesById[s];if(r)return r}},_processCoverageResult:function(e,t){var i=this;e.ts=Date.now(),e.files=[],e.tests=[],e.log=t.log,e.globalErrors=t.globalErrors;var s=i._settings.reportConsoleErrorAsError&&{};e.log=_.filter(e.log,function(t){if("log"===t.type&&_.isNumber(t.file)&&_.isNumber(t.range)){var n=i._getFileMetadataById(t.file),r=t.range;n&&(t.range=n.ranges[r],t.range.length||(t.range=n.ranges[r-1]),t.range&&t.range.length||delete t.range)}else if("error"===t.type&&s){var a={message:"\n"!==t.text&&t.text||"[console.error without any message]",stack:[]};if(t.spec){var o=s[t.spec]=s[t.spec]||[];o.push(a)}else e.globalErrors||(e.globalErrors=[]),e.globalErrors.push(a);return!1}return!0}),n("Processed console.log entries"),_.each(t.loadingSequence,function(e,t){_.each(e,function(e){var n=i._structure.filesById[e];n&&(n.testFilesLoadedFrom=n.testFilesLoadedFrom||{},n.testFilesLoadedFrom[t]=m)})}),n("Processed loading sequences");var r={},a={};return _.each(t.tests,function(t){if(!t.skipped){if(s){var o=s[t.id];o&&(t.log=(t.log||[]).concat(o))}for(var l=e.tests,u=e,c=0,h=t.suite.length;h>c;c++){var d=t.suite[c];u=_.find(l,function(e){return e.name===d&&e.tests}),u||(u={name:d,tests:[]},l.push(u)),l=u.tests}var f=i.findTestFile(t.files);if(!f)return void console.warn("Test without test file id, most likely the test did not run",{testFileIdCanNotBeDetermined:t.name,id:t.id,log:t.log,filesInvolved:_.map(t.files,function(e){var t=i._structure.filesById[e];return t?t.path:"unknown or deleted file"})});var v=f.id,p=t.suite.slice();p.unshift(f.path),p.push(t.name);var b=p.join(g);t.log&&t.log.length&&i._testTask.failingTest(v,p);var T=a[b];T?(n("Test name duplicate: "+t.name),t.name+=" #"+T,a[b]=T+1):a[b]=1;var w={name:t.name,id:t.id,fileId:v,log:t.log,time:t.time,slow:t.slow};u.tests.push(w),r[t.id]={out:w,timeRange:t.timeRange},_.each(t.files,function(e){var t=i._structure.filesById[e];
t&&(t.tests[b]=m)}),_.each(t.log,function(e){e.external&&e.stack&&(_.each(e.stack,function(e){var t=i._structure.filesById[e[0]];t&&(t.tests[b]=t.tests[b]||y)}),delete e.external)})}}),n("Processed executed tests"),i._updateFileOrder(),_.each(t.changed===!0?i._structure.sourceFilesInOrder.concat(i._structure.testFilesInOrder):_.map(t.changed,function(e,t){return i._getFileMetadataById(t)}),function(e){if(e){var n=e.id;_.isNumber(n)&&!t.coverage[n]&&i._isJavaScript(e)&&(t.coverage[n]=[])}}),_.each(t.coverage,function(n,s){s=parseInt(s,10);var a=t.changed[s],o={id:s,ranges:[],changed:t.changed===!0||!!a,singleTestChanged:!(!a||!a.singleTestChange)||void 0},l=i._getFileMetadataById(s).ranges,u={};_.each(l,function(e,t){if(e.length){var i=e.join("."),s=!1,a=n[t],l=_.map(a,function(t,i){if(i=parseInt(i,10),!i)return null;var n=r[i];if(!n)return null;var a=n.timeRange;return a?(a[0]===t&&(n.out.start=e[0]),s=!0,i):i});if(o.changed||l.length){var c={items:e,hits:l},h=u[i];h?s&&(h.hits=l):(u[i]=c,o.ranges.push(c))}}}),e.files.push(o)}),n("Processed code coverage"),e},_filesAreUpToDate:function(e){var t=this;return t._structure.awaitingFiles=_.without.bind(null,t._structure.awaitingFiles).apply(null,e),t._signalIfBecameLive()},_filesAreRequired:function(e){var t=this;t._structure.awaitingFiles=_.union(t._structure.awaitingFiles,e),t._structure.awaitingFiles.length&&(t._live=!0,t._emit({type:"filesRequired",files:t._structure.awaitingFiles}))},_signalIfBecameLive:function(){var e=this;return!e._structure||e._structure.awaitingFiles.length||e._live?void 0:(e._live=!0,e._emit({type:"live"}),n("Stopping process pool"),e._processorPool.stop(),!0)},_writeFileChanges:function(e,t,i){var r=this;e.changeTs=+new Date;var a,o=[];_.each(t,function(e){var t=_.isPatch(e);t?o.push(e):(a=e,o.length=0)});var l=o.length===t.length;return n("File %s changes are patches only: %s",e.path,l),Q.all([l?r._readSourceFile(e.id,e.originalPath):Q.when(!1),r._dirEnsurePromise(s.dirname(e.originalPath)),r._dirEnsurePromise(s.dirname(e.instrumentedPath))]).then(function(t){l&&(a=t[0]);var i=void 0;return delete e.lastChangeIsComplex,_.each(o,function(t){var n=r._diffMatchPatch.patch_fromText(t),s=1===o.length&&3===t.split("@@").length;s?e.test&&_.each(n,function(e){e.diffs&&e.diffs.length&&2==e.diffs[0].length&&!e.diffs[0][0]&&(i=e.start2+e.diffs[0][1].length)}):e.lastChangeIsComplex=!0,a=r._diffMatchPatch.patch_apply(n,a)[0]}),Q.all([r._writeSourceFile(e.originalPath,e.binary?new Buffer(a,"base64"):a),r._processFile(e,a,i,!r._live,!1)])}).then(function(){return e.ts=i,n("File %s changes saved, store ts: %s, change ts: %s",e.path,e.ts,e.changeTs),Q.when(!0)})},_processFile:function(e,t,i,s,r){var a=this;e.changeStart=i,n("Preparing to process %s",e.path),t=t&&t.toString()||"","node"===a.settings().env.type&&a._isJavaScript(e)&&(t=t.replace(/^\#\!.*/,""),a._settings.testFramework.jsPreprocessor&&(t=a._settings.testFramework.jsPreprocessor(t))),s&&a._startProcessorPool(),e.changeStart&&!e.noCompilers&&(e.changePosition=_.textIndexPosition(t,e.changeStart));var o=function(){return n("File "+e.path+" is not instrumented by core"),e.ranges=[],e.validSyntax=!0,Q.when({code:t})};return(e.binary||!e.coverable&&!e.test?Q.fcall(o):(r?Q.when(t):a._runThroughProcessors(e,t,s,!0).fail(function(t){return a._cleanStack(t),Q.reject(new Error("Failed to run compilers on "+e.path+", "+(t&&(t.stack||t.message))))})).then(function(t){if(!e.noCompilers){n("Processing compiled "+e.path),e.instrumentedType="js";var i=e.sourceMap,r=new d(i);delete e.sourceMap;var l=_.reduce(e.ranges,function(e,t){var i=e[t[0]]=e[t[0]]||[];return i.push(t),e},{});if(e.changePosition){e.changePosition.source=i.sources&&i.sources[0]||".";var u=a._findClosestRange(l,e.changePosition,!0);u&&(e.changePosition.column=u[1]),e.changeStart=r.generatedPositionFor(e.changePosition)}var c=a._isOriginallyCoffeeScript(e),h=function(t){_.each(t,function(t){var i={line:t[0],column:t[1]},n=r.originalPositionFor(i);if(n.source||(i.column+=7,n=r.originalPositionFor(i),n.source||(c?(i.column+=7,n=r.originalPositionFor(i)):(i.column+=26,n=r.originalPositionFor(i)))),n.source)var s=a._findClosestRange(l,n);s?(e.lineMap[t[0]]=s[0],t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3]):t.length=0})}}return!a._isOriginallyJavaScript(e)&&e.noCompilers?Q.fcall(o):(n("Instrumenting "+e.path+", via process pool: "+s),a._instrument(t,{file:e.tmp?e.originalId:e.id,testFileChangeStart:e.changeStart,fullMap:!e.noCompilers},s).then(function(t){if(t.error)throw t.error;return h&&h(t.ranges),e.validSyntax=!0,e.ranges=t.ranges,e.lineMap=e.noCompilers?t.map:a._updateFileMap(e.lineMap,[JSON.parse(t.map)]),delete e.tmpLineMap,e.numberOfFunctionsChanged=e.numberOfFunctions!==t.numberOfFunctions,e.numberOfFunctions=t.numberOfFunctions,e.lastSingleChangeTest=e.changeStart&&!e.numberOfFunctionsChanged&&t.testName,e.lastSingleChangeTest&&n("Detected single test [%s] change",t.testName),Q.when(t)}).fail(function(t){return e.validSyntax=!1,a._cleanStack(t),Q.when(new Error("Failed to parse "+e.path+", "+(t&&(t.stack||t.message))))}))})).then(function(t){return t instanceof Error?Q.when(t):a._runThroughProcessors(e,t.code,s,!1).then(function(t){var i=e.binary?new Buffer(t,"base64"):t;return n("Writing to disk and caching processed file %s",e.path),a._doWriteFileWithLruCache(e.instrumentedPath,i)}).fail(function(t){return a._cleanStack(t),Q.when(new Error("Failed to run preprocessors on "+e.path+", "+(t&&(t.stack||t.message))))})}).then(function(e){return e instanceof Error?Q.reject(e):Q.when(e)})},_findClosestRange:function(e,t,i){var n=e[t.line];if(n)for(var s,r=1/0,a=0;a<n.length;a++){var o=n[a],l=Math.abs(o[1]-t.column);r>l&&(!i||o[1]<=t.column)&&(r=l,s=o)}return s},_runThroughProcessors:function(e,t,i,s){var r=this;if(!Object.keys(s?r._settings.compilers:r._settings.preprocessors).length||(s?e.noCompilers:e.noPreprocessors))return n("No %s configured for %s",s?"compilers":"preprocessors",e.path),s?e.noCompilers=!0:e.noPreprocessors=!0,Q.when(t);var a={content:t,config:r._configFile,file:e,root:r._instrumentedRoot,type:s?"compiler":"preprocessor"};return(i?r._processorPool.run(a):o(a)).then(function(t){if(t.error)throw t.error;return s?e.noCompilers=t.noProcessors:e.noPreprocessors=t.noProcessors,r._updateInstrumentedFile(t,e,s&&!e.noCompilers),Q.when(t.content)})},_updateInstrumentedFile:function(e,t,i){var r=this;i&&delete t.lineMap,e.maps&&e.maps.length&&(t.lineMap=r._updateFileMap(t.lineMap,e.maps)),e.newPath&&(t.instrumentedPath=s.resolve(r._instrumentedRoot,e.newPath),t.instrumentedType=_.trim(s.extname(t.instrumentedPath),"."),r._structure.filesRenamed[e.newPath]=t.path),i&&(t.ranges=e.ranges,t.sourceMap=e.maps&&e.maps[0],t.ranges&&t.ranges.length||n("Compiler did not set ranges for file [%s]",t.path),t.sourceMap||n("Compiler did not set source map for file [%s]",t.path))},_updateFileMap:function(e,t){e=e||{};var i=_.extend({},e);return _.each(t,function(e){var t=new d(e),n={},s=_.isEmpty(i),r=_.extend({},i);t.eachMapping(function(e){if(e.generatedLine&&e.originalLine){var t=n[e.generatedLine];if(!t||e.name){var a=r[e.originalLine],o=a||t;o?n[e.generatedLine]=o:s&&(n[e.generatedLine]=e.originalLine),a&&delete i[e.originalLine],"__awaiter"===e.name&&delete n[e.generatedLine]}}}),i=_.extend({},i,n)}),i},_instrument:function(e,t,i){var n=this;return i?n._processorPool.run({content:e,opts:t,type:"instrumentor"}):Q.fcall(function(){return a(e,t)})},_writeSourceFile:function(e,t){var i=this,n=i._sourceFileCache[e];return n?(n.content=t,Q.when(!0)):i._doWriteFile(e,t)},_doWriteFile:function(e,t){var i=this;return i._dirEnsurePromise(s.dirname(e)).then(function(){return i._writeFilePromise(e,t)})},_doWriteFileWithLruCache:function(e,t){var i=this;return i._dirEnsurePromise(s.dirname(e)).then(function(){return i._writeFilePromise(e,t)}).then(function(){return i._lruCache.set(e,t),Q.when(!0)})},_deleteSourceFile:function(e){var t=this;return delete t._sourceFileCache[e],t._unlinkFilePromise(e)},readSourceFile:function(e){var t=this._getFileMetadataById(e);return t&&this._readSourceFile(e,t.originalPath)},_readSourceFile:function(e,t){var i=this,s=i._sourceFileCache[t];return s?(n("Returning previously cached file [%s] from memory",e),Q.when(s.content)):i._readFilePromise(t).then(function(s){var r=Q.when(!0),a=_.keys(i._sourceFileCache);if(a.length>=2){var o=a[0],l=i._sourceFileCache[o];delete i._sourceFileCache[o],i._structure.filesById[l.id]?(r=i._doWriteFile(o,l.content),n("Writing previously cached file [%s] to disk",o)):n("Previously cached file [%s] was deleted and does not need saving to disk",o)}return n("Caching file [%s] in memory",e),i._sourceFileCache[t]={content:s,id:e},r.then(function(){return Q.when(s)})})},_flushSourceFileCacheSync:function(){var e=this;try{_.each(e._sourceFileCache,function(t,i){e._dirEnsureSync(s.dirname(i)),e._writeFileSync(i,t.content)})}catch(t){_.each(e._sourceFileCache,function(t){var i=e._structure.filesById[t.id];i&&(i.ts=0)})}},_getOrCreateFileMetadata:function(e){var t=this,i=t._structure.filesByPath[e.path];if(!i){var n=t._createFileMetadata(e,e.id);return t._fileOrderUpdatePending=!0,n}return i},_getFileMetadataById:function(e){var t=this;return t._structure.filesById[e]},_createFileMetadata:function(e,t){var i=this;if(s.resolve(e.path)===s.normalize(e.path).replace(new RegExp(s.sep+"$"),""))throw new Error("Configured file paths must be relative: "+e.path);var n=s.join(i._originalRoot,e.path),r=s.join(i._instrumentedRoot,e.path),a={id:t,path:e.path,type:e.type||"js",binary:e.binary||void 0,tmp:e.tmp||void 0,instrumentedType:e.instrumentedType||e.type||"js",order:e.order,originalPath:n,instrumentedPath:r,ts:e.ts,changeTs:e.ts,triggersTests:e.triggersTests,include:e.include,initialInclude:_.isBoolean(e.initialInclude)?e.initialInclude:e.include,coverable:e.coverable,test:e.test,tests:e.tests||{},ranges:e.ranges||void 0,lineMap:e.lineMap||void 0,tmpLineMap:e.tmpLineMap||void 0,validSyntax:e.validSyntax||void 0,numberOfFunctions:e.numberOfFunctions||void 0,getFileLineMap:function(){return this.tmpLineMap||this.lineMap}};return i._updateFileStructure(a),a},_deleteTmpFiles:function(){var e=this;this._deleteDependantFilesMetadata(),_.each(e._structure.filesByPath,function(t){return t.tmp&&e._deleteFileMetadata(t)}),e._fileOrderUpdatePending=!0},_deleteDependantFilesMetadata:function(e){var t=this;e?(_.each(e.dependant,function(e){return t._deleteFileMetadata(e)}),e.dependant={}):_.each(t._structure.filesByPath,function(e){return t._deleteDependantFilesMetadata(e)})},_deleteFileMetadata:function(e){var t=this,i=t._structure.filesByPath[e.path];return i?(t._updateFileStructure(i,!0),t._fileOrderUpdatePending=!0,i):void 0},_updateFileStructure:function(e,t){var i=this;t?(i._deleteDependantFilesMetadata(e),delete i._structure.filesById[e.id],delete i._structure.testFilesById[e.id],delete i._structure.filesByPath[e.path]):(i._structure.filesById[e.id]=e,i._structure.filesByPath[e.path]=e,e.test&&(i._structure.testFilesById[e.id]=e))},_updateFileOrder:function(){var e=this;e._fileOrderUpdatePending&&(e._structure.testFilesInOrder=[],e._structure.sourceFilesInOrder=[],_.each(e._orderFilesByConfig(e._structure.filesByPath),function(t){t.test?e._structure.testFilesInOrder.push(t):e._structure.sourceFilesInOrder.push(t)}),delete e._fileOrderUpdatePending)},_orderFilesByConfig:function(e){return _.chain(e).sortBy(function(e){return e.path}).sortBy(function(e){return e.order}).value()}}),t.exports=b},{"./config":5,"./instrumentor":10,"./processor":16,"./testTask":19,"./tracking":21,child_process:void 0,debug:void 0,"lru-cache":void 0,minimatch:void 0,module:void 0,path:void 0,"source-map":void 0}],18:[function(e,t,i){var n,s=e("os"),r=e("path"),a=e("http"),o=e("ws").Server,l=5e3,u=200,c="&wallabyFileId=",h="Wallaby.js cache is corrupted, please restart wallaby.js",d=function(t,i){var s=this;n=e("debug")("wallaby:workers"),s._project=t,s._opts=t.settings(),s._extension=i,s._sessions={},s._executedTestNumber=0,s._workers={},s._calculateNumberOfParallelWorkers();for(var r=0;r<Math.max(s._maxWorkers,s._minWorkers);r++)s.getWorker(r)};d.prototype={start:function(e){var t=this,i=e?a.createServer(e):a.createServer();return i.listen(0),Q.promise(function(e,s){i.on("listening",function(){try{t._receiverPort=i.address().port,n("Web server is listening at "+t._receiverPort),t._wss=new o({server:i,verifyClient:function(e){return _.verifyLocalOrigin(e.origin)}}),t._wss.on("connection",function(e){e.on("message",function(i){var s;try{s=JSON.parse(i)}catch(r){return void console.error("Failed to deserialize message from worker: "+i+", "+(r&&r.message))}if(s.worker){var a=t._workers[s.worker];if(!a)return;a.onConnected&&a.onConnected(e)}else if(s.session){var o=t._sessions[s.session],l=!o||o._disposing||t._cancelled;if("console"===s.type&&s.data){if("debugLog"===s.data.type)return void n(s.data.text);(!s.data.spec||l)&&console.log("console."+s.data.type+": "+s.data.text)}if(l)return;try{o[s.type](s.data)}catch(r){console.error("Failed to process message "+s.type+" from worker, "+(r&&r.message)),o.reject(r)}}})}),e()}catch(r){s(r)}})})},wallabyFileIdPrefix:function(e){var t=function(){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(){return c}),receiverPort:function(){return this._receiverPort},setFileRoot:function(e){this._fileRoot=e},run:function(e){var t=this;return t._cancelled=!1,t._executedTestNumber=0,t._runPriority=e.priority,n("Starting test run, priority: "+t._runPriority),(e.fullRun&&t._maxWorkers>1&&e.testFilesToLoad.length>1?t._runInParallel(e,t._maxWorkers):t._minWorkers>1&&e.testFilesToLoad.length>1?t._runInParallel(e,t._minWorkers):t._extension.prepare(e,0).then(function(e){return t._runTests(e)})).then(function(e){return t._executedTestNumber&&console.log("Finished executing "+t._executedTestNumber+" affected test(s)"),Q.when(e)})},_handleError:function(e,t,i,s){var r=this;n("Sandbox (%s) [%s] error: %s",e.active()?"active":"inactive",t,i);var a=r._reportableError(i,s),o="SyntaxError: Parse error"===i&&_.isEmpty(s);if(r._corruptedCache(a))return r._project.invalidateCache(),void e.reject(new Error(h));if(console.error("Runtime error: "+a),e.active()){if(e.scheduleCompleteIfNotActiveFor(100),!s)return void e.reject(new Error(i));if(!o)try{var l={message:i,stack:_.isString(s)?s:_.reduce(s,function(e,t){return e+t.file+":"+t.line+"\n"},""),external:!0},u=[l];r._processTestLog(u),l.stack&&l.stack.length||(l.message=a,l.stack=[]),e.addToTestLog(l)}catch(c){e.reject(new Error(i+", "+(c&&c.message)))}}},_runTests:function(e){var t=this;if(t.cancelled())return Q.reject({runCancelled:!0});n("Running tests in sandbox [%s]",e.name);var i=e.sessionId,s=e.workerId;return Q.promise(function(n,r){t.cancelled()&&r({runCancelled:!0});try{var a=t._createSession(i,s,e.instance,n,r);e.instance.start(function(e){return t.cancelled()?(a.reject({runCancelled:!0}),!1):"success"!==e?(a.reject(new Error("Sandbox load failed, status: "+e)),!1):!0},function(e,n){t._handleError(a,i,e,n)})}catch(o){r(o)}}).then(function(e){if(e.session){var t=e.session,i=t._coverage,n=t._loadingSequence,s=t._tests,r=t._log,a=t._globalErrors.concat(t._executingTestLog);return a.length||(a=void 0),_.each(_.keys(t),function(e){e&&"_"===e[0]&&!_.isFunction(t[e])&&"_disposing"!==e&&delete t[e]}),delete e.session,Q.when({coverage:i,tests:s,log:r,globalErrors:a,loadingSequence:n})}return Q.when(e)})},_reportableError:function(e,t){var i=this;if(_.isString(t)){var n={stack:t};return i._project._cleanStack(n),t=n.stack}return e},cancel:function(e){var t=this;if(!_.isEmpty(t._sessions))return e>=t._runPriority?(_.each(t._sessions,function(e){e.reject({runCancelled:!0})}),t._cancelled=!0,n("Cancelling test run, cancel requester priority: %s, current run priority: %s",e,t._runPriority),!0):!1},cancelled:function(){return this._cancelled},_createSession:function(e,t,i,s,r){var a=this;return a._sessions[e]={_coverage:{},_tests:[],_loadingSequence:{},_log:[],_executingTestLog:[],_globalErrors:[],_total:0,_skipped:0,_disposing:!1,_exceededMaxTestAllowedLogLimit:!1,_onFinished:i.closing,_messagesPerTest:{},_closeByErrorTimeout:0,_longRunningWarningTimeout:0,_longRunningPingTimeout:0,_executingFiles:{},_executingTest:void 0,started:function(e){var t=this;n("Loaded %s test(s)",e.total),this._total=e.total,_.each(e.loadingSequence,function(e){e.length>1&&(t._loadingSequence[e[0]]=e.slice(1))})},active:function(){return!this._disposing&&!a._cancelled},scheduleCompleteIfNotActiveFor:function(e){var t=this;clearTimeout(t._closeByErrorTimeout),t._closeByErrorTimeout=setTimeout(function(){t.complete()},e)},addToTestLog:function(e){var t=this._executingTestLog[this._executingTestLog.length-1];t&&t.message===e.message&&t.stack&&e.stack&&t.stack.length>0&&e.stack.length>0&&_.isEqual(e.stack[0],t.stack[0])?e.stack.length>t.stack.length&&(t.stack=e.stack):this._executingTestLog.push(e)},complete:function(){var e=this;clearTimeout(this._closeByErrorTimeout),clearTimeout(this._longRunningWarningTimeout),clearTimeout(this._longRunningPingTimeout),e._onFinished(),this._dispose(function(){a._cancelled?r({runCancelled:!0}):s({session:e})}),n("Run %s test(s), skipped %s test(s)",this._tests.length-this._skipped,this._skipped)},globalError:function(t){a._handleError(this,e,t.message,t.stack)},programScopeStart:function(e){this._executingFiles[e]=1,this._setTimeoutForLongRunningOperation()},programScopeEnd:function(e){delete this._executingFiles[e],_.isEmpty(this._executingFiles)&&!this._executingTest&&(clearTimeout(this._longRunningWarningTimeout),clearTimeout(this._longRunningPingTimeout))},preTest:function(e){this._setTimeoutForLongRunningOperation(),this._executingTest=e},_setTimeoutForLongRunningOperation:function(){var e=this;clearTimeout(this._longRunningWarningTimeout),clearTimeout(this._longRunningPingTimeout),this._longRunningWarningTimeout=setTimeout(function(){var t="Some long running code has been detected: ",n=e._executingTest,s=!_.isEmpty(e._executingFiles);if(t+=(n?'test "'+n+'"':"one of your "+(s?"files":"tests"))+" is taking more than "+l+"ms to execute.",s&&(t+="\nExecution of the following files has started but has not finished:",_.each(e._executingFiles,function(e,i){var n=a._project._getFileMetadataById(i);t+="\n- "+(n?n.path:"unknown")})),e._log.length&&(t+="\nThe last recorded console.log: "+_.last(e._log).text),n||s){t+="\nTry commenting out the test or excluding the test file from the `tests` list in your wallaby config,\nand restarting wallaby to make sure that it is this test/file causing the issue and not something else.",n&&(t+="\nAlso review your recent changes to the code that the test covers, as well as its `before` and `after` hooks."),t+="\nPinging test runner sandbox...";try{i.ping(function(){clearTimeout(e._longRunningPingTimeout),e.active()&&console.warn("Sandbox is responsive. The issue may have the asynchronous nature, like a missing callback.")}),e._longRunningPingTimeout=setTimeout(function(){console.warn("The sandbox is not responsive. Check for possibly recently introduced infinite loops.")},u)}catch(r){t+="\nThe sandbox ping failed: "+r.message}}console.warn(t)},l)},test:function(e){var t=function(t){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(e){var t=this;return delete this._executingTest,clearTimeout(this._closeByErrorTimeout),this._setTimeoutForLongRunningOperation(),e.hook&&e.log?(a._processTestLog(e.log),_.isString(e.hook)&&_.each(e.log,function(t){t.message=e.hook+(t.message?": ":"")+t.message}),void(this._globalErrors=this._globalErrors.concat(e.log))):(e.skipped?(this._skipped++,a._processTestLog(e.log)):(n("Test executed: "+e.name),a._processTestLog(e.log),e.log&&_.each(e.log,function(e){return t.addToTestLog(e)}),this._executingTestLog.length&&(e.log=this._executingTestLog.slice()),_.isUndefined(e.slow)&&(e.slow=e.time>a._opts.slowTestThreshold),e.slow=e.slow||void 0,this._executingTestLog.length=0,++a._executedTestNumber%50||console.log("Execution progress: "+a._executedTestNumber+" tests")),void this._tests.push(e))}),coverage:function(e){this._coverage[e.id]=e.ranges},console:function(e){var t=function(t){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(e){var t=a._opts.maxConsoleMessagesPerTest,i=this._messagesPerTest[e.spec]=(this._messagesPerTest[e.spec]||0)+1;i===t+1?console.warn("Number of console messages per test exceeded maximum allowed value ("+t+"), current test console messages recording stopped.\nYou may increase the limit by adding `maxConsoleMessagesPerTest` setting to your config file."):t>=i&&this._log.push(e)}),resume:function(){n("Sandbox requested early screen shot capture"),this._onFinished(),this._onFinished=_.noop,i.resume()},reject:function(e){var t=function(t){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(e){this._disposing||this._dispose(function(){r(a._cancelled?{runCancelled:!0}:e)})}),_dispose:function(s){this._disposing=!0,clearTimeout(this._closeByErrorTimeout),clearTimeout(this._longRunningWarningTimeout),clearTimeout(this._longRunningPingTimeout);var r=!1,o=function(){r=!0,delete a._sessions[e],s()};try{i.ping(function(){r||(n("Sandbox [%s] is responsive, closing it",e),a._tryClosingSandbox(i.close),o())})}catch(l){n("Sandbox [%s] can not be pinged: %s",e,l&&l.message)}setTimeout(function(){r||(n("Sandbox [%s] is not responsive, recycling worker instance",e),a._tryClosingSandbox(i.close),a.recycleWorker(t),o())},1e3)}}},_tryClosingSandbox:function(e,t){try{e()}catch(i){n("Sandbox [%s] closing error, %s",t,i.message)}},_corruptedCache:function(e){return e&&e.match(/evaluating '[a-z]\.\$_\$coverage\[/)},_processTestLog:function(e){var t=this,i=c.length;_.each(e,function(e){var s=e.message,a=s&&s.indexOf(" in file:///")||-1;if(~a&&(e.message=s.substring(0,a)),t._corruptedCache(e.message)&&(t._project.invalidateCache(),e.message=h),e.stack&&_.isString(e.stack)){var o,l=[],u=e.stack.split("\n");u&&t._corruptedCache(u[0])&&(t._project.invalidateCache(),e.message=h),_.each(u,function(e){var n=e.lastIndexOf(c),s=t._fileRoot?e.lastIndexOf(t._fileRoot):-1;if(~n){var a=e.substr(n+i).split(":");a.length>=2&&(o=t._project.stackEntryByFileId(parseInt(a[0],10),parseInt(a[1],10)),o&&o.line&&l.push([o.file,o.line])),delete t._fileRoot}else if(~s){var u=_.rtrim(e.substr(s+t._fileRoot.length),")").split(":");3===u.length&&(o=t._project.stackEntryByFilePath(t._project.normalizePath(_.ltrim(u[0],r.sep)),parseInt(u[1],10)),o&&o.line&&l.push([o.file,o.line]))}}),l.length||n("Failed to map the stack to user code, entry message: %s, stack: %s",e.message&&e.message.substring(0,1024),e.stack.substring(0,1024)),e.stack=l}})},_runInParallel:function(e,t){var i=this,s=e.testFilesToLoad,r={};n("Distributing tests between %s workers",t);for(var a=0;t>a;a++){var o=_.omit(e,"testFiles");o.testFilesToLoad=[],r[a]={opts:o,workerId:a,ranges:0}}return _.each(s,function(e){var t=_.sortBy(r,function(e){return e.ranges})[0];t.opts.testFilesToLoad.push(e),t.ranges+=e.rangesLength}),n("Running tests in parallel"),Q.all(_.chain(r).filter(function(e){return e.ranges}).map(function(e){return i._extension.prepare(e.opts,e.workerId).then(function(e){return i._runTests(e)})}).value()).then(function(e){n("Merging parallel test run results");var t=_.reduce(e,function(e,t){e.runCancelled=t.runCancelled||e.runCancelled,e.tests=e.tests.concat(t.tests||[]),e.log=e.log.concat(t.log||[]),e.globalErrors=e.globalErrors.concat(t.globalErrors||[]),e.error=t instanceof Error||e.error,e.loadingSequence=_.extend(e.loadingSequence,t.loadingSequence||{});var i=e.coverage;return _.isEmpty(i)?(e.coverage=t.coverage,e):(_.each(t.coverage,function(e,t){var n=i[t];return n?void _.each(e,function(e,t){var i=n[t];return i?void _.extend(i,e):void(n[t]=e)}):void(i[t]=e)}),e)},{coverage:{},tests:[],log:[],globalErrors:[],loadingSequence:{}});return t.runCancelled?Q.reject(t):t.error?Q.reject(t.error):Q.when(t)})},getWorker:function(e){var t=this,i=t._workers[e];return i||(i=t._workers[e]={id:e,promise:Q.promise(function(i,s){var r=t._workers[e];if(r)if(r.instance){if(t._extension.healthy(r.instance))return void i(r);n("Found inactive run worker instance #%s, recycling",e),t.recycleWorker(e)}else if(r.promise)return r.promise;n("Starting run worker instance #"+e);try{t._extension.create(e,function(r){if(!r)return void s(new Error("Failed to create worker instance"));var a=t._workers[e]=t._workers[e]||{id:e};if(r.onConnected){a.onConnected=_.bind(r.onConnected,a),delete r.onConnected;var o,l;a.promise=Q.promise(function(e,t){o=e,l=t});var u=!1,c=setTimeout(function(){u||(h(),t.recycleWorker(e),n("Worker is not created in time, recycling it"),l&&l({runCancelled:!0,rerun:!0}),s({runCancelled:!0,rerun:!0}))},1e4),h=function(){u=!0,clearTimeout(c)};a.onConnected(function(t){u||(h(),n("Started run worker instance (delayed) #"+e),a.instance=r,r.channel=t,a.promise=Q.when(r),o&&o(r),i(r))})}else n("Started run worker instance (immediate) #"+e),a.instance=r,a.promise=Q.when(r),i(r)})}catch(a){s(a)}})}),i.promise},recycleWorker:function(e){var t=this;try{var i=t._workers[e];i&&i.instance&&t._extension.recycle(i.instance)}catch(s){n("Error while recycling run worker instance #%s: %s",e,s&&(s.stack||s.message))}finally{delete t._workers[e]}},stop:function(){var e=this;_.each(e._workers,function(t,i){e.recycleWorker(i)}),e._wss&&e._wss.close()},_calculateNumberOfParallelWorkers:function(){var e=this;e._maxWorkers=Math.max(1,e._opts.workers.initial||Math.max(s.cpus().length-2,2)),e._minWorkers=Math.max(1,e._opts.workers.regular||Math.max(Math.floor(e._maxWorkers/2),2)),n("Parallelism for initial run: %s, for regular run: %s",e._maxWorkers,e._minWorkers)}},t.exports=d},{debug:void 0,http:void 0,os:void 0,path:void 0,ws:void 0}],19:[function(e,t,i){"use strict";var n=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r={testRunPriority:1,fileChangePriority:2,fullRunPriority:3},a=function(){function t(e){s(this,t),this._filesAndAffectedTests={},this._failingTests={},this._tests=[],this._priority=0,this._project=e}return n(t,{files:{value:function(){return _.reduce(this._filesAndAffectedTests,function(e,t){return e[t.file.id]=t.file,e},{})}},hasFiles:{value:function(){return _.keys(this._filesAndAffectedTests).length>1}},addTests:{value:function(e){this._tests=this._tests.concat(e)}},addChangedFile:{value:function(e,t){this._mergeAffectedTests(e.id,{file:e,tests:t,testFilesLoadedFrom:e.testFilesLoadedFrom})}},setTestRunPriority:{value:function(){this._priority=r.testRunPriority}},setFileChangeRunPriority:{value:function(){this._priority=r.fileChangePriority}},setFullRunPriority:{value:function(){this._priority=r.fullRunPriority}},getFullRunPriority:{value:function(){return r.fullRunPriority}},getPriority:{value:function(){return this._priority}},isFullRun:{value:function(){return this._priority===r.fullRunPriority}},isFileChangedRun:{value:function(){return this._priority===r.fileChangePriority}},isManualRun:{value:function(){return this._priority===r.testRunPriority}},filesAdded:{value:function(){this._anyFilesAdded=!0}},filesDeleted:{value:function(){this._anyFilesDeleted=!0}},anyFilesAdded:{value:function(){return this.isFullRun()||this._anyFilesAdded}},anyFilesDeleted:{value:function(){return this._anyFilesDeleted}},mergeTask:{value:function(e){var t=this;t._priority=Math.max(t._priority,e._priority),_.each(e._filesAndAffectedTests,function(e,i){t._mergeAffectedTests(i,e)}),t._failingTests=_.extend({},e._failingTests,t._failingTests),t._tests=t._tests.concat(e._tests),t._anyFilesAdded=t._anyFilesAdded||e._anyFilesAdded,t._anyFilesDeleted=t._anyFilesDeleted||e._anyFilesDeleted}},_mergeAffectedTests:{value:function(e,t){var i=this,n=i._filesAndAffectedTests[e];n?(n.tests=n.tests?n.tests.concat(t.tests):t.tests,n.testFilesLoadedFrom=_.extend(n.testFilesLoadedFrom||{},t.testFilesLoadedFrom||{})):i._filesAndAffectedTests[e]=t}},failingTest:{value:function(e,t){var i=this._failingTests[e]=this._failingTests[e]||[];i.push(t)}},_getAllTests:{value:function(){var t=this,i=[],n=!1,s={},r={},a=0,o=0,l=0,u=0,c=0;if(_.each(t._filesAndAffectedTests,function(e){var o=e.file;e.tests=_.map(e.tests,function(e){var i=t._getTestFileId(e);return s[i]||(s[i]=1,a++),o.numberOfFunctionsChanged||o.lastChangeIsComplex?[e[0]]:e}),o.test&&(n=!0),o.test&&o.lastSingleChangeTest&&!t._project.hadGlobalErrorsPreviousRun()&&(e.tests=[[o.id,"?",o.lastSingleChangeTest]]),i=i.concat(e.tests),_.extend(r,e.testFilesLoadedFrom||{})}),_.each(t._tests,function(e){var i=t._getTestFileId(e);s[i]||(s[i]=1,o++)}),i=i.concat(t._tests),!i.length&&t._project._lastAffectedTestFileIds&&(i=i.concat(_.map(t._project._lastAffectedTestFileIds,function(e){return s[e]||(s[e]=1,l++),[e]}))),_.each(r,function(e,t){t=parseInt(t,10),s[t]||(s[t]=1,i.push([t]),u++)}),!(n&&1===_.size(t._filesAndAffectedTests)||t.isManualRun())){var h=[],d={};_.each(i,function(e){var i=t._getTestFileId(e);if(!d[i]){var n=t._failingTests[i];n&&(h=h.concat(n),s[i]=1,d[i]=1,c++)}}),i=i.concat(h)}return e("debug")("wallaby:testTask")("Test files from affected: %s, from deleted or manually requested: %s, from recently changed: %s, from loaded by: %s, from failing: %s",a,o,l,u,c),i}},testData:{value:function(){return this._getTestRunData()}},_getTestRunData:{value:function(){var e=this;if(!this.isFullRun()){var t=e._getAllTests();if(t){var i={},n={};return _.each(t,function(t){var s=i,r=e._getTestFileId(t);if(r){var a=e._project._structure.testFilesById[r];if(a&&(n[a.id]=a,1===t.length&&(i="*"),"*"!==i))for(var o=1,l=t.length;l>o;o++){var u=t[o],c=s[":"+u],h=o===l-1;if((!c||h)&&(c=s[":"+u]=h?"*":{}),"*"===c)break;s=c}}}),{files:n,names:i}}}}},_getTestFileId:{value:function(e){var t=e&&e[0];if(t)return _.isNumber(t)?t:(this._project._structure.filesByPath[t]||{}).id}}}),t}();t.exports={TestTask:a,runPriority:r}},{debug:void 0}],20:[function(e,t,i){!function(e){e.addEventListener&&e.addEventListener("beforeunload",function(){throw new Error("One of your tests is trying to unload window object.")});var t,i=/%[sdj%]/g,n=16384;"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(e){var t=Array.prototype.slice.call(arguments,1),i=this,n=function(){},s=function(){return i.apply(this instanceof n?this:e||{},t.concat(Array.prototype.slice.call(arguments)))};return n.prototype=this.prototype||{},s.prototype=new n,s});var s=function(){var t=this;t._noOp=function(){},t._undefined=e.undefined,t._setTimeout=e.setTimeout,t._Date=e.Date,t._Error=e.Error,t._JSONStringify=JSON.stringify,t._XMLHttpRequest=e.XMLHttpRequest,t._replacedConsoleLog=e.console.log=function(){t._suppressConsoleLog||t._doWhenReceiverIsReady(function(e){t._log.apply(t,e)},arguments)},e.console.warn=function(){t._doWhenReceiverIsReady(function(e){t._warn.apply(t,e)},arguments)},e.console.error=function(){t._doWhenReceiverIsReady(function(e){t._error.apply(t,e)},arguments)},e.console.dir=function(){t._doWhenReceiverIsReady(function(e){t._dir.apply(t,e)},arguments)},t._receiver=e.$_$receiver||new e.WebSocket("ws://127.0.0.1:"+e.$_$receiverPort),t._onReceiverReady=[function(){t._receiverReady=!0}],t._receiver.onopen=function(){for(var e=0,i=t._onReceiverReady.length;i>e;e++)t._onReceiverReady[e]()},t._receiver.onerror=function(e){throw new Error("Sandbox receiver error: "+e.message)},t.reset()};s.prototype={setGlobalErrorHandler:function(){var t=this;e.$_$reuseableTracer||(e.onerror=function(){t._globalError.apply(t,arguments)})},_globalError:function(){var e=this;e._doWhenReceiverIsReady(function(t){e._sendGlobalError.apply(e,t)},arguments)},initialSpecId:function(){return e.$_$initialSpecId;
},start:function(t){var i=this;if(t||!(i._delayStart||i._startRequested&&!e.$_$reuseableTracer))if(i.reset(),t)this._onStart=t,this._patchFrameworks();else{if(!this._onStart)throw new Error("Missing tracer start subscription");i._startRequested=!0,this._receiverReady?this._onStart():this._onReceiverReady.push(this._onStart)}},isInitialized:function(){return!!e.$_$coverage},statement:function(i,n){e.$_$coverage[i][n][this._spec]=t++},scopeStart:function(e){this._fileEncounter[e]||(this._fileEncounterSequence.push(e),this._fileEncounter[e]=1)},programScopeStartLoading:function(e){this._testFileIds[e]&&this._resetFileData(),this.scopeStart(e)},programScopeEndLoading:function(e){this._testFileIds[e]&&(this._saveCurrentTestLoadingSequence(),this._resetFileData())},_saveCurrentTestLoadingSequence:function(){this._fileEncounterSequence.length&&this._testLoadingSequence.push(this._fileEncounterSequence.slice())},started:function(t){t=t||{},t.loadingSequence=this._testLoadingSequence.slice(),this._resetLoadingData(),this._resetFileData(),e.$_$wp=this._original_$_$wp,e.$_$wpe=this._original_$_$wpe,this._send("started",t)},specStart:function(e,t){var i=this;this._doWhenReceiverIsReady(function(){i._send("preTest","string"==typeof t?t:i._format(t))}),this._spec=e,this._resetFileData()},specSyncStart:function(){this._specRangeStart=t},specSyncEnd:function(){this._specRangeEnd=t-1},specEnd:function(e){var t=function(){return e.apply(this,arguments)};return t.toString=function(){return e.toString()},t}(function(){this._spec=0;var e=this._specRangeStart,i=this._specRangeEnd;return this._specRangeStart=0,this._specRangeEnd=0,[e,i||t]}),needToNotifySingleTestRun:function(){if(this._paused||this._onResumed||!this.hasSpecFilter()||e.$_$reuseableTracer)return!1;for(var t=e.$_$tests;"*"!==t;){var i=Object.keys(t);if(1!=i.length)return!1;t=t[i[0]]}return!0},notifySingleTestAfterEach:function(t){return this._paused||this._onResumed||e.$_$reuseableTracer?void t():(this._paused=!0,this._onResumed=t,void this._send("resume"))},resume:function(){this._paused&&(this._paused=!1,this._onResumed&&(this._onResumed(),delete this._onResumed))},paused:function(){return this._paused},hasSpecFilter:function(){return!!e.$_$tests&&"*"!==e.$_$tests},specFilter:function(t){var i=e.$_$tests[":?"];if(i&&i[":"+t[t.length-1]])return!0;for(var n=e.$_$tests,s=0,r=t.length;r>s;s++){var a=t[s];if(n=n[":"+a],!n)return!1;if("*"===n)return!0}return!1},complete:function(t){if(e.$_$coverage){for(var i=0,n=e.$_$coverage.length;n>i;i++){var s=e.$_$coverage[i];s&&s.length&&this._send("coverage",{id:i,ranges:s})}this._send("complete",t),e.$_$reuseableTracer||this._receiver.close()}},result:function(e){e.files=this._fileEncounterSequence,this._send("test",e)},_patchFrameworks:function(){var t=this;if(!t._patchedFrameworks){t._patchedFrameworks=!0;var i=e.requirejs&&"function"==typeof e.requirejs.load,n=e.System&&e.System.transpiler;if(t._shouldReportProgramScope=t._shouldReportProgramScope||i||n,i){var s=e.requirejs.load;e.requirejs.load=function(e,i,n){return s.call(this,e,i,t._urlWithFileData(n))}}if(n){var r=e.System.fetch;e.System.fetch=function(){var e=arguments[0]&&arguments[0].address;return e&&(arguments[0].address=t._urlWithFileData(e)),r.apply(this,arguments)}}if(t._XMLHttpRequest){var a=t._XMLHttpRequest.prototype.open;t._XMLHttpRequest.prototype.open=function(e,i){arguments[1]=t._urlWithFileData(i),a.apply(this,arguments)}}t._Error&&!t._Error.captureStackTrace&&e.navigator&&e.navigator.userAgent&&/PhantomJS\/2/.test(e.navigator.userAgent)&&(t._Error.captureStackTrace=function(){})}},_urlWithFileData:function(e){var t=this;if(e&&~e.indexOf("wallabyFileId"))return e;for(var i=[],n=e.replace(/\\/g,"/").split("/"),s=0;s<n.length;s++)"."!==n[s]&&(".."===n[s]&&i.length&&".."!==i[i.length-1]?i.pop():i.push(n[s]));return e=i.join("/"),e=t._appendFileData(e)},_appendFileData:function(t){var i=this,n="/"===t.charAt(0)?t.substr(1):t,s=e.location&&e.location.host&&t.indexOf(e.location.host);s>=0&&(n=n.substr(s+e.location.host.length+1));var r=t.lastIndexOf("?");r>=0&&(n=n.substring(0,r));var a=n&&i._getFileMetadata(n);return a?t+(~r?"&":"?")+a.ts+"&wallabyFileId="+a.id:t},_getFileMetadata:function(t){return e.$_$files[t]||e.$_$files[t.split("\\").join("/")]},_doWhenReceiverIsReady:function(e,t){var i=this;i._receiverReady?e(t):i._onReceiverReady.push(function(){e(t)})},_log:function(){this._sendLog("log",this._format.apply(this,arguments))},_warn:function(){this._sendLog("warn",this._format.apply(this,arguments))},_error:function(){this._sendLog("error",this._format.apply(this,arguments))},_dir:function(e){this._sendLog("dir",this._inspect(e))},_debugLog:function(){this._sendLog("debugLog",this._format.apply(this,arguments))},_sendGlobalError:function(e,t,i){e=e&&e.toString()||"",t=t&&t.toString()||"",i=i&&i.toString()||"",this._send("globalError",{message:e,stack:e+"\nat "+t+":"+i})},debugLog:function(){var e=this;e._doWhenReceiverIsReady(function(t){e._debugLog.apply(e,t)},arguments)},log:function(){var t=this;if(t._replacedConsoleLog!==e.console.log){for(var i=[],n=arguments.length-2,s=0;n>s;s++)i.push(arguments[s]);t._suppressConsoleLog=!0,e.console.log.apply(console,i),t._suppressConsoleLog=!1}t._doWhenReceiverIsReady(function(e){for(var i=[],n=e.length-2,s=0;n>s;s++)i.push(e[s]);t._sendLog("log",t._format.apply(t,i)||"",e[n],e[n+1])},arguments)},setAssertionData:function(e,t){try{var i=Object.prototype.toString.call(e.actual);e.showDiff===!0&&i==Object.prototype.toString.call(e.expected)&&void 0!==e.expected&&"[object Boolean]"!==i&&"[object Number]"!==i&&"[object Function]"!==i&&("string"!=typeof e.actual&&(e.actual=this._inspect(e.actual,5),e.expected=this._inspect(e.expected,5)),t.actual=e.actual,t.expected=e.expected),"UnexpectedError"===e.name&&e.getErrorMessage&&(t.formattedDiff=e.getErrorMessage("ansi").toString())}catch(n){}return t},_sendLog:function(e,t,i,s){var r=t?t.length:0;t&&r>n&&(t=t.slice(0,4096)+"...\n(truncated, total length: "+r+")"),this._send("console",{type:e,text:t||"",spec:this._spec,file:i,range:s})},_send:function(t,i){var n=this._JSONStringify({type:t,data:i,session:e.$_$session});this._receiver.send(n)},_resetLoadingData:function(){this._testLoadingSequence=this._safeObject([])},_resetFileData:function(){this._fileEncounterSequence=this._safeObject([]),this._fileEncounter=this._safeObject([])},reset:function(){var e=this;t=1,e._spec=0,e._specRangeStart=0,e._specRangeEnd=0,e._resetFileData()},_safeObject:function(e){return e.toJSON=this._undefined,e},_format:function(e){var t;if("string"!=typeof e){var n=[];for(t=0;t<arguments.length;t++)n.push(this._inspect(arguments[t]));return n.join(" ")}t=1;for(var s=arguments,r=s.length,a=String(e).replace(i,function(e){if("%%"===e)return"%";if(t>=r)return e;switch(e){case"%s":return String(s[t++]);case"%d":return Number(s[t++]);case"%j":return JSON.stringify(s[t++]);default:return e}}),o=s[t];r>t;o=s[++t])a+=null===o||"object"!=typeof o?" "+o:" "+this._inspect(o);return a},_inspect:function(e,t){var i={seen:[],showHidden:!1,depth:t||2,stylize:function(e){return e}};return this._formatValue(i,e,i.depth)},_formatValue:function(e,t,i){var n=this,s=this._formatPrimitive(e,t);if(s)return s;var r=Object.keys(t),a=this._arrayToHash(r);if(e.showHidden&&(r=Object.getOwnPropertyNames(t)),0===r.length){if("function"==typeof t){var o=t.name?": "+t.name:"";return e.stylize("[Function"+o+"]","special")}if(this._isRegExp(t))return e.stylize(RegExp.prototype.toString.call(t),"regexp");if(this._isDate(t))return e.stylize(Date.prototype.toString.call(t),"date");if(this._isError(t))return this._formatError(t)}var l="",u=!1,c=["{","}"];if(this._isArray(t)&&(u=!0,c=["[","]"]),"function"==typeof t){var h=t.name?": "+t.name:"";l=" [Function"+h+"]"}if(this._isRegExp(t)&&(l=" "+RegExp.prototype.toString.call(t)),this._isDate(t)&&(l=" "+Date.prototype.toUTCString.call(t)),this._isError(t)&&(l=" "+this._formatError(t)),0===r.length&&(!u||0==t.length))return c[0]+l+c[1];if(0>i)return this._isRegExp(t)?e.stylize(RegExp.prototype.toString.call(t),"regexp"):e.stylize("[Object]","special");e.seen.push(t);var d;return d=u?this._formatArray(e,t,i,a,r):r.map(function(s){return n._formatProperty(e,t,i,a,s,u)}),e.seen.pop(),this._reduceToSingleString(d,l,c)},_isArray:function(e){return Array.isArray(e)||"object"==typeof e&&"[object Array]"===this._objectToString(e)},_isRegExp:function(e){return"object"==typeof e&&"[object RegExp]"===this._objectToString(e)},_isDate:function(e){return"object"==typeof e&&"[object Date]"===this._objectToString(e)},_isError:function(e){return"object"==typeof e&&("[object Error]"===this._objectToString(e)||e instanceof Error)},_objectToString:function(e){return Object.prototype.toString.call(e)},_reduceToSingleString:function(e,t,i){var n=0,s=e.reduce(function(e,t){return n++,t.indexOf("\n")>=0&&n++,e+t.length+1},0);return s>60?i[0]+(""===t?"":t+"\n ")+" "+e.join(",\n  ")+" "+i[1]:i[0]+t+" "+e.join(", ")+" "+i[1]},_formatPrimitive:function(e,t){switch(typeof t){case"undefined":return e.stylize("undefined","undefined");case"string":var i="'"+JSON.stringify(t).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(i,"string");case"number":return e.stylize(""+t,"number");case"boolean":return e.stylize(""+t,"boolean")}return null===t?e.stylize("null","null"):void 0},_formatError:function(e){return"["+Error.prototype.toString.call(e)+"]"},_formatArray:function(e,t,i,n,s){for(var r=this,a=[],o=0,l=t.length;l>o;++o)this._hasOwnProperty(t,String(o))?a.push(this._formatProperty(e,t,i,n,String(o),!0)):a.push("");return s.forEach(function(s){s.match(/^\d+$/)||a.push(r._formatProperty(e,t,i,n,s,!0))}),a},_formatProperty:function(e,t,i,n,s,r){var a,o,l;if(l=Object.getOwnPropertyDescriptor(t,s)||{value:t[s]},l.get?o=l.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):l.set&&(o=e.stylize("[Setter]","special")),this._hasOwnProperty(n,s)||(a="["+s+"]"),o||(e.seen.indexOf(l.value)<0?(o=null===i?this._formatValue(e,l.value,null):this._formatValue(e,l.value,i-1),o.indexOf("\n")>-1&&(o=r?o.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+o.split("\n").map(function(e){return"   "+e}).join("\n"))):o=e.stylize("[Circular]","special")),"undefined"==typeof a){if(r&&s.match(/^\d+$/))return o;a=JSON.stringify(""+s),a.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.substr(1,a.length-2),a=e.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=e.stylize(a,"string"))}return a+": "+o},_arrayToHash:function(e){var t={};return e.forEach(function(e){t[e]=!0}),t},_hasOwnProperty:function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},initLoadingPhase:function(){var t=this;this._resetLoadingData(),delete this._loadingSequence,this._testFileIds=this._safeObject({}),(e.$_$testFiles||[]).forEach(function(e){t._testFileIds[e.id]=1}),t._original_$_$wp=e.$_$wp,t._original_$_$wpe=e.$_$wpe,e.$_$wp=function(e){t._reportProgramScope("programScopeStart",e),t.programScopeStartLoading(e)},e.$_$wpe=function(e){t._reportProgramScope("programScopeEnd",e),t.programScopeEndLoading(e)}},_reportProgramScope:function(e,t){var i=this;this._shouldReportProgramScope&&this._doWhenReceiverIsReady(function(){i._send(e,t)})}};var r=new s;r.setGlobalErrorHandler(),e.$_$w=function(e,t){r.statement(e,t)},e.$_$wp=function(e){r._reportProgramScope("programScopeStart",e),r.scopeStart(e)},e.$_$wpe=function(e){r._reportProgramScope("programScopeEnd",e)},e.$_$wf=function(e){r.scopeStart(e)},e.$_$tracer=r,e.$_$coverage=e.$_$coverage||[];var a=function(e){return e.path},o=function(e){return e?e.replace(/\\/g,"/"):e},l=e.$_$testFiles&&(e.$_$testFiles||[]).map(a).map(o),u=e.$_$testFiles&&e.$_$testFiles.filter(function(e){return e.loaded}).map(a);r.initLoadingPhase(),e.wallaby={delayStart:function(){r._patchFrameworks(),r._delayStart=!0},start:function(){r._delayStart=!1,r.start()},_startWhenReceiverIsReady:function(e){r._shouldReportProgramScope=!0,r._doWhenReceiverIsReady(function(){e()})},tests:l,loadedTests:u,baseDir:e.$_$baseDir,slowTestThreshold:e.$_$slow||75}}(function(){return this}()||global)},{}],21:[function(e,t,i){"use strict";var n=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=e("path"),a=e("node-uuid"),o=e("querystring"),l=e("http"),u={Atom:"AT",VSCode:"VSC",Sublime:"ST"},c=function(){function e(t,i){if(s(this,e),t&&_.isString(i)){var n=this,o=t.client&&u[t.client];this._client=o||(~i.indexOf("wallaby-vscode")?"VSC":~i.indexOf(".wallaby")?"VS":~i.indexOf("atom-wallaby")?"AT":~i.indexOf("Sublime")?"ST":"IJ");var l="VS"===this._client?r.join(i,"..","..","t.id"):r.join(i,"..","t.id"),c=void 0;try{c=t.readFileSync(l)}catch(h){c=a.v4();try{t.writeFileSync(l,c)}catch(d){}}this._cid=c||a.v4(),this._tid="UA-58409118-3",this._sendHeartbeat=!0,this._heartbeatInterval=setInterval(function(){return n._heartbeat()},3e5),n._heartbeat()}}return n(e,{dispose:{value:function(){clearInterval(this._heartbeatInterval)}},busy:{value:function(){this._sendHeartbeat=!0}},_heartbeat:{value:function(){this._sendHeartbeat&&this._event("Heartbeat","Active",this._client),delete this._sendHeartbeat}},_event:{value:function(e,t,i){try{var n=o.stringify({v:1,tid:this._tid,cid:this._cid,t:"event",ec:e,ea:t,el:i}),s={hostname:"www.google-analytics.com",path:"/collect",method:"POST",headers:{"Content-Length":n.length}},r=l.request(s,function(e){e.on("data",_.noop),e.on("end",_.noop)});r.on("error",_.noop),r.write(n),r.end()}catch(a){}}}}),e}();t.exports=c},{http:void 0,"node-uuid":void 0,path:void 0,querystring:void 0}],22:[function(e,t,i){"use strict";var n,s=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=e("./typeScriptVisitor"),o=e("semver"),l="1.5.3",u=function(){function e(t){r(this,e),this._opts=t||{},this._opts=_.extend({noLib:!0,noResolve:!0,removeComments:!0},t||{},{sourceMap:!0}),this._noRename=this._opts.noFileRename,delete this._opts.noFileRename,delete this._opts.forceFileLevelCompiler,this._visitor=new a(n)}return s(e,{run:{value:function(e){var t=this,i=e.content,s=e.path;this._code="",this._ranges=[];var r=n.createProgram([s],this._opts,{getSourceFile:function(e){var s=n.createSourceFile(e,i,t._opts.target);return t._ranges=t._visitor.visit(s),s},writeFile:function(e,i){t._code=i},useCaseSensitiveFileNames:function(){return!1},getCanonicalFileName:function(e){return e},getCurrentDirectory:function(){return""},getNewLine:function(){return"\n"}}),a=r.emit(),o=a.diagnostics;if(!o.length){var l=a.sourceMaps[0];if(!l)throw new Error("Cannot find the file source map. If it is a definition file, you may need to exclude it in your files list.");var u={version:3,file:l.sourceMapFile,sourceRoot:l.sourceMapSourceRoot,sources:l.sourceMapSources,names:l.sourceMapNames,mappings:l.sourceMapMappings};return t._noRename||e.changeExt("js"),{map:u,code:this._code,ranges:this._ranges}}throw new Error("Typescript compiler errors: "+_.reduce(o,function(e,t){return e+"\n"+t.messageText},""))}}}),e}();t.exports=function(t){return n=t.typescript?t.typescript:e("typescript"),o.valid(n.version)&&o.lt(n.version,l)?void console.error("TypeScript version for compiler must be >= "+l):(delete t.typescript,function(e){return new u(t).run(e)})}},{"./typeScriptVisitor":24,semver:void 0,typescript:void 0}],23:[function(e,t,i){"use strict";var n,s=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=e("path"),o=e("graceful-fs"),l=e("minimatch"),u=e("semver"),c=e("./typeScriptVisitor"),h="1.5.3",d=function(){function t(e,i){r(this,t);var s=this;e=e||{},this._filePatterns=[],this._optionDeclarations=_.reduce(n.optionDeclarations,function(e,t){return e[t.name]=t,e},{}),this._localProjectDir=i,e.files?(this._opts=!1,_.each(e.files,function(e,t){s._filePatterns.push(t);var i=s._createOptions(e);s._opts||(s._opts=i)})):(this._filePatterns.push("**/*.ts"),this._opts=this._createOptions(e)),this._allTrackedFiles={},this._visitor=new c(n)}return s(t,{_createOptions:{value:function(e){return e&&(this._orderFilesByReferenceComments=e.orderFilesByReferenceComments,delete e.orderFilesByReferenceComments),_.extend({noLib:!0,noResolve:!0,removeComments:!0,declaration:!1,noEmitOnError:!1,noEmit:!1},this._normaliseOptions(e)||{},{sourceMap:!0,inlineSourceMap:!1,inlineSources:!1,outDir:void 0,rootDir:void 0,mapRoot:void 0,outFile:void 0})}},_normaliseOptions:{value:function(e){var t=this;if(e)return _.each(e,function(i,n){var s=t._optionDeclarations[n];s&&_.isObject(s.type)&&_.isString(i)&&(e[n]=_.find(s.type,function(e,t){return t===i.toLowerCase()}))}),e}},_mergeTsConfigOptions:{value:function(t,i){var s,r=a.join(this._localProjectDir,"tsconfig.json");try{s=e(r).compilerOptions}catch(l){try{s=n.readConfigFile(r,function(e){return o.readFileSync(e).toString()}).config.compilerOptions}catch(u){i.debug("Error reading tsconfig file from "+r+"\n("+l.message+", "+u.message+")")}}return s?_.extend(this._normaliseOptions(s)||{},t):t}},createPostprocessor:{value:function(){var e=this;return function(t){var i=t.logger,s=e._filesToBeCompiled(t.affectedFiles);if(!e._compiler||t.anyFilesAdded||t.anyFilesDeleted){if(e._compiler?i.debug("TypeScript language service re-created because some tracked files were added or deleted"):i.debug("New TypeScript language service is required"),s=e._allTrackedFiles=e._filesToBeCompiled(t.allFiles),_.isEmpty(s))return i.debug("TypeScript postprocessor will be removed because in %s project files none were found by patterns: %s",t.allFiles.length,e._filePatterns),Q.when({removePostprocessor:!0});e._opts=e._mergeTsConfigOptions(e._opts,i),e._compiler=e._createLanguageService(t.baseDir)}else _.each(s,function(t){var i=e._allTrackedFiles[t.fullPath];i&&(i.ts=t.ts)});var r=[];return _.each(s,function(s){if(e._orderFilesByReferenceComments&&e._dependencies){var o=e._dependencies.files[s.path];o&&o.hash!==e._getFileDependencies(s).hash&&delete e._dependencies}var l=e._compiler.getEmitOutput(s.fullPath);if(l.emitSkipped){var u=e._compiler.getCompilerOptionsDiagnostics().concat(e._compiler.getSyntacticDiagnostics(s.fullPath)).concat(e._compiler.getSemanticDiagnostics(s.fullPath));u.forEach(function(e){var t=n.flattenDiagnosticMessageText(e.messageText,"\n");if(e.file){var s=e.file.getLineAndCharacterOfPosition(e.start);i.error("  Error "+e.file.fileName+" ("+(s.line+1)+","+(s.character+1)+"): "+t)}else i.error("  Error: "+t)})}var c=e._visitor.visit(e._compiler.getSourceFile?e._compiler.getSourceFile(s.fullPath):e._compiler.getProgram().getSourceFile(s.fullPath)),h={};l.outputFiles.forEach(function(e){var t=a.extname(e.name);".map"===t?h.sourceMap=e.text:".js"===t||".jsx"===t?h.code=e.text:i.debug("Unexpected output file: %s",e.name)}),h.sourceMap&&r.push(t.createFile({path:e._opts.module?e._changeExtToJs(s.path):s.path+".compiled.js",original:s,content:h.code,sourceMap:JSON.parse(h.sourceMap),ranges:c,order:s.order,load:s.initialLoad}))}),e._orderFilesByReferenceComments&&!e._dependencies&&e._updateFileOrder(),Q.all(r)}}},_updateFileOrder:{value:function(){var e=this;e._dependencies={files:{},min:Number.POSITIVE_INFINITY},_.each(e._allTrackedFiles,function(t){return e._orderFilesByReferences(t,e._dependencies)});var t=e._dependencies.min;_.each(e._dependencies.files,function(e){e.file.test||e.file.setOrder(t++,!0)})}},_orderFilesByReferences:{value:function(e,t){var i=this;if(!t.files[e.path]){e.test||(t.min=Math.min(t.min,e.order));var n=i._getFileDependencies(e);_.each(n.items,function(e){return i._orderFilesByReferences(e,t)}),t.files[e.path]||(t.files[e.path]={hash:n.hash,file:e})}}},_getFileDependencies:{value:function(e){var t,i,s,r=this,o="",l=_(n.preProcessFile(e.getContentSync()).referencedFiles).map(function(t){return r._allTrackedFiles[a.join(a.dirname(e.fullPath),t.fileName)]}).filter(function(e){return!_.isUndefined(e)}).map(function(e){return o+=e.path,e}).value(),u=0;if(o.length>0)for(t=0,s=o.length;s>t;t++)i=o.charCodeAt(t),u=(u<<5)-u+i,u|=0;return{items:l,hash:u}}},_changeExtToJs:{value:function(e){return e.substr(0,e.lastIndexOf(".")+1)+"js"}},_createLanguageService:{value:function(e){var t=this;return n.createLanguageService({getScriptFileNames:function(){return Object.keys(t._allTrackedFiles)},getScriptVersion:function(e){var i=t._allTrackedFiles[e];return i&&i.ts.toString()},getScriptSnapshot:function(e){var i=t._allTrackedFiles[e];return i&&n.ScriptSnapshot.fromString(i.getContentSync())},getCurrentDirectory:function(){return e},getCompilationSettings:function(){return t._opts},getDefaultLibFileName:function(e){return n.getDefaultLibFilePath(e)}},n.createDocumentRegistry())}},_filesToBeCompiled:{value:function(e){var t=this;return _.reduce(e,function(e,i){return _.find(t._filePatterns,function(e){return l(i.path,e)})&&(e[i.fullPath]=i),e},{})}}}),t}();t.exports=function(t){return function(i){if(i.typescript)n=i.typescript;else try{n=e(a.join(t,"node_modules","typescript"))}catch(s){n=e("typescript")}if(u.valid(n.version)&&u.lt(n.version,h))throw new Error("TypeScript version for compiler must be >= "+h);return delete i.typescript,new d(i,t).createPostprocessor()}}},{"./typeScriptVisitor":24,"graceful-fs":void 0,minimatch:void 0,path:void 0,semver:void 0,typescript:void 0}],24:[function(e,t,i){"use strict";var n=function(){function e(e,t){for(var i in t){var n=t[i];n.configurable=!0,n.value&&(n.writable=!0)}Object.defineProperties(e,t)}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(t){s(this,e);var i=this,n={};this._ts=t,n[t.SyntaxKind.DoStatement]=n[t.SyntaxKind.WhileStatement]=n[t.SyntaxKind.IfStatement]=n[t.SyntaxKind.SwitchStatement]=function(e){e.expression&&i._pushRange(e.expression)},n[t.SyntaxKind.ForStatement]=function(e){e.condition&&i._pushRange(e.condition)},n[t.SyntaxKind.ForInStatement]=n[t.SyntaxKind.ForOfStatement]=function(e){e.expression&&i._pushRange(e.expression)},n[t.SyntaxKind.BreakStatement]=n[t.SyntaxKind.ContinueStatement]=n[t.SyntaxKind.ThrowStatement]=function(e){i._pushRange(e)},n[t.SyntaxKind.VariableStatement]=function(e){(!i._parent||i._parent.kind!==t.SyntaxKind.ForStatement&&i._parent.kind!==t.SyntaxKind.ForInStatement&&i._parent.kind!==t.SyntaxKind.ExportAssignment)&&i._pushRange(e)},n[t.SyntaxKind.ExpressionStatement]=n[t.SyntaxKind.ReturnStatement]=function(e){i._pushRange(e)},n[t.SyntaxKind.ConditionalExpression]=function(e){i._pushRange(e.whenTrue),i._pushRange(e.whenFalse)},n[t.SyntaxKind.BinaryExpression]=function(e){i._pushRange(e.left),i._pushRange(e.right)},n[t.SyntaxKind.ArrowFunction]=function(e){e.body.statements||i._pushRange(e.body)},i._visit=function(e){var s=n[e.kind];s&&s(e),i._parent=e,t.forEachChild(e,i._visit)}}return n(e,{visit:{value:function(e){var t=this;return t._ranges=[],t._parent=null,t._sourceFile=e,t._visit(e),t._parent=null,t._sourceFile=null,t._ranges.slice()}},_pushRange:{value:function(e){this._ranges.push(this._getRange(e))}},_getRange:{value:function(e){var t=this._ts.getLineAndCharacterOfPosition(this._sourceFile,e.getStart(this._sourceFile)),i=this._ts.getLineAndCharacterOfPosition(this._sourceFile,e.getEnd());return[t.line+1,t.character,i.line+1,i.character]}}}),e}();t.exports=r},{}],25:[function(e,t,i){t.exports={randomId:function(){return Math.random().toString(36).substr(2,5)},noopTrue:function(){return!0},noopTruePromise:function(){return Q.fcall(this.noopTrue)},isPatch:function(e){return e&&e.length>2&&"@"===e[0]&&"@"===e[1]},textIndexPosition:function(e,t){var i=this.textLines(e,t);return{line:i.length,column:i[i.length-1].length}},textLines:function(e,t){return e=_.isUndefined(t)?e:e.substr(0,t),e.split(/\r\n|\r|\n/)},verifyLocalOrigin:function(t,i){if(!t)return!0;var n=!1;try{var s=e("url").parse(t).hostname;n="localhost"===s||"0.0.0.0"===s||"127.0.0.1"===s||"::1"===s}catch(r){}return n||i||console.error("wallaby.js refused to accept connection from "+t),n}}},{url:void 0}],26:[function(e,t,i){t.exports={name:"Wallaby.js",version:"1.0.279",author:"Wallaby.js",license:"Proprietary",homepage:"http://wallabyjs.com",dependencies:{acorn:"3.1.0","acorn-jsx":"3.0.1",chokidar:"1.0.3","coffee-script":"1.10.0",commander:"2.5.0",debug:"2.1.0","escodegen-wallaby":"1.6.7",express:"4.11.2","fs-extra":"0.12.0","graceful-fs":"4.1.3",lodash:"3.0.0","lru-cache":"2.5.0",minimatch:"2.0.1","node-uuid":"1.4.3",phantom:"0.7.2",q:"1.0.1",semver:"4.3.3","source-map":"0.4.3",typescript:"1.8.2","underscore.string":"2.3.3",ws:"1.1.1"},devDependencies:{"browserify-transform-tools":"1.5.0",escodegen:"1.6.1","expect.js":"0.3.1",grunt:"*","grunt-babel":"4.0.0","grunt-browserify":"*","grunt-bump":"0.0.16","grunt-contrib-clean":"*","grunt-contrib-compress":"0.12.0","grunt-contrib-copy":"*","grunt-contrib-uglify":"*"},"private":!0}},{}],27:[function(e,t,i){var n,s,r,a=e("path"),o=function(t,i){var n=e("module").Module,s=n.prototype,r=n._nodeModulePaths,a=s.require;n._nodeModulePaths=function(e){var i=r.call(this,e);return t(i),i},i&&(s.require=function(e){return a.call(this,i(e))})};if(process.env&&process.env.NODE_MODULES_OVERRIDE&&(console.warn(" ---- Using node modules from: "+process.env.NODE_MODULES_OVERRIDE+" ---- "),o(function(e){e.unshift(process.env.NODE_MODULES_OVERRIDE)})),"worker"!==process.argv[2]&&"runner"!==process.argv[2]){n=e("graceful-fs");var l=e("fs-extra"),u=e("./lib/app"),c=e("commander");c.unknownOption=function(){},c.option("-p, --port <port>","specify port").option("-l, --projectCachePath <projectCachePath>","specify project cache location").option("-l, --configPath <configPath>","specify config file location").option("-r, --phantomjs <phantomjs>","specify phantomjs location").option("-k, --lkp [lkp]","specify lkp location").option("-c, --client [client]","specify client").parse(process.argv);var h={port:47878,location:a.join(__dirname,"lib","project")};c.port&&(h.port=c.port),c.projectCachePath&&(h.projectCachePath=c.projectCachePath),c.configPath&&(h.configPath=c.configPath),c.phantomjs&&(h.phantomjs=c.phantomjs),h.runnerResolver=function(t,i){return e("browser"===t?"electron"===i?"./lib/electronRunner.js":"./lib/phantomRunner.js":"./lib/nodeRunner.js")},h.processorPool=e("./lib/processPool"),h.fileStructureCachePromise=function(e){return Q.nfcall(n.readFile,e).then(function(e){return Q.when(JSON.parse(e))})},h.fileStatPromise=function(e){return Q.nfcall(n.stat,e)},h.readFilePromise=function(e){return Q.nfcall(n.readFile,e)},h.writeFilePromise=function(e,t){return Q.nfcall(n.writeFile,e,t)},h.unlinkFilePromise=function(e){return Q.nfcall(n.unlink,e)},h.unlinkFileSync=function(e){return n.unlinkSync(e)},h.writeFileSync=function(e,t){return n.writeFileSync(e,t)},h.readFileSync=function(e){return n.readFileSync(e).toString("utf8")},h.fileExistsSync=function(e){return n.existsSync(e)},h.realpathSync=function(e){return n.realpathSync(e)},h.dirRemovePromise=function(e){return Q.nfcall(l.remove,e)},h.dirRemoveSync=function(e){return l.removeSync(e)},h.dirEnsurePromise=function(e){return Q.nfcall(l.ensureDir,e)},h.dirEnsureSync=function(e){return l.ensureDirSync(e)},h.nodeModulesLookup=o,h.onStart=_.noop,h.onConnected=_.noop;var d=e("phantom/receiver");if(h._init=d.create,h.coreVersion=e("./package.json").version,"extended-core"!==process.argv[2]&&"extended-core-ws"!==process.argv[2]){h.Receiver=e("./lib/project");var f=e("ws").Server,v=new f({port:h.port,verifyClient:function(e){return _.verifyLocalOrigin(e.origin)}},function(){console.log("wallaby.js started"),console.log("core v"+h.coreVersion)});v.on("connection",function(e){var t={send:function(t){e.send(JSON.stringify(t))},receive:_.noop};h.onConnected(t),e.on("message",function(e){t.receive(JSON.parse(e))})})}else if("extended-core"!==process.argv[2]){h.client=c.client||"Sublime",h.lkp=c.lkp,h.Receiver=d.create();var p=e("ws").Server,g=new p({port:h.port,verifyClient:function(e){return _.verifyLocalOrigin(e.origin)}},function(){console.log("wallaby.js started")});g.on("connection",function(t){var i={send:function(e){t.send(JSON.stringify(e))},receive:_.noop};h.onConnected(i),t.on("message",function(e){var t=JSON.parse(e);i.receive(t),"stop"===t.type&&process.exit()}),i.send({type:"started",version:e("./package.json").version})})}else{h.client=c.client||"Atom",h.lkp=c.lkp;e("util");h.Receiver=d.create(),process.nextTick(function(){var e={send:function(e){process.send(e)},receive:_.noop};process.on("message",function(t){if("connection"===t.type)h.onConnected(e);else try{e.receive(t)}finally{"stop"===t.type&&process.exit()}}),e.send({type:"started",version:h.coreVersion})})}u.start(h)}else"runner"!==process.argv[2]?(e("./lib/global"),process.on("message",function(t){if(t&&"exit"===t.type)return void process.exit(0);if("instrumentor"===t.type){var i=e("./lib/instrumentor");try{var n=i(t.content,t.opts);process.send(n)}catch(s){process.send({error:{message:s&&s.message,stack:s&&s.stack}})}}else if("preprocessor"===t.type||"compiler"===t.type){var r=e("./lib/processor");try{r(t).fail(function(e){process.send({error:{message:e&&e.message,stack:e&&e.stack}})}).then(function(e){process.send(e)})}catch(s){process.send({error:{message:s&&s.message,stack:s&&s.stack}})}}}),process.send("READY")):(s=process.argv[7],s&&(n=e("fs"),r=a.join(process.cwd(),"node_modules"),o(function(e){for(var t=0,i=e.length;i>t&&e[t]!==r;t++);e.splice(t+1,0,s)},function(e){var t=e.replace(r,s);return t===e||n.existsSync(t)?t:e})),e("./lib/nodeTestWorker")(process.argv[3],process.argv[4],process.argv[5],process.argv[6],s))},{"./lib/app":1,"./lib/electronRunner.js":7,"./lib/global":9,"./lib/instrumentor":10,"./lib/nodeRunner.js":11,"./lib/nodeTestWorker":12,"./lib/phantomRunner.js":13,"./lib/processPool":15,"./lib/processor":16,"./lib/project":17,"./package.json":26,commander:void 0,fs:void 0,"fs-extra":void 0,"graceful-fs":void 0,module:void 0,path:void 0,"phantom/receiver":void 0,util:void 0,ws:void 0}]},{},[27]);