/*
 * Wallaby.js - v1.0.279
 * http://wallabyjs.com
 * Copyright (c) 2014-2016 Wallaby.js - All Rights Reserved.
 *
 * This source code file is a part of Wallaby.js and is a proprietary (closed source) software.

 * IMPORTANT:
 * Wallaby.js is a tool made by software developers for software developers with passion and love for what we do.
 * Pirating the tool is not only illegal and just morally wrong,
 * it is also unfair to other fellow programmers who are using it legally,
 * and very harmful for the tool and its future.
 */
function Runner(e){var t=this;this._globals=[],this._abort=!1,this.suite=e,this.total=e.total(),this.failures=0,this.on("test end",function(e){t.checkGlobals(e)}),this.on("hook end",function(e){t.checkGlobals(e)}),this.grep(/.*/),this.globals(this.globalProps().concat(extraGlobals()))}function filterLeaks(e,t){return filter(t,function(t){if(/^d+/.test(t))return!1;if(global.navigator&&/^getInterface/.test(t))return!1;if(global.navigator&&/^\d+/.test(t))return!1;if(/^mocha-/.test(t))return!1;var i=filter(e,function(e){return~e.indexOf("*")?0==t.indexOf(e.split("*")[0]):t==e});return 0==i.length&&(!global.navigator||"onerror"!==t)})}function extraGlobals(){if("object"==typeof process&&"string"==typeof process.version){var e=process.version.split(".").reduce(function(e,t){return e<<8|t});if(2315>e)return["errno"]}return[]}var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runner"),Test=require("./test"),utils=require("./utils"),filter=utils.filter,keys=utils.keys,globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date","setImmediate","clearImmediate"];module.exports=Runner,Runner.immediately=global.setImmediate||process.nextTick,Runner.prototype.__proto__=EventEmitter.prototype,Runner.prototype.grep=function(e,t){return debug("grep %s",e),this._grep=e,this._invert=t,this.total=this.grepTotal(this.suite),this},Runner.prototype.grepTotal=function(e){var t=this,i=0;return e.eachTest(function(e){var n=t._grep.test(e.fullTitle());t._invert&&(n=!n),n&&i++}),i},Runner.prototype.globalProps=function(){for(var e=utils.keys(global),t=0;t<globals.length;++t)~utils.indexOf(e,globals[t])||e.push(globals[t]);return e},Runner.prototype.globals=function(e){return 0==arguments.length?this._globals:(debug("globals %j",e),this._globals=this._globals.concat(e),this)},Runner.prototype.checkGlobals=function(e){if(!this.ignoreLeaks){var t,i=this._globals,n=this.globalProps();e&&(i=i.concat(e._allowedGlobals||[])),this.prevGlobalsLength!=n.length&&(this.prevGlobalsLength=n.length,t=filterLeaks(i,n),this._globals=this._globals.concat(t),t.length>1?this.fail(e,new Error("global leaks detected: "+t.join(", "))):t.length&&this.fail(e,new Error("global leak detected: "+t[0])))}},Runner.prototype.fail=function(e,t){++this.failures,e.state="failed","string"==typeof t&&(t=new Error('the string "'+t+'" was thrown, throw an Error :)')),this.emit("fail",e,t)},Runner.prototype.failHook=function(e,t){this.fail(e,t),this.suite.bail()&&this.emit("end")},Runner.prototype.hook=function(e,t){function i(e){var n=s[e];return n?(r.currentRunnable=n,n.ctx.currentTest=r.test,r.emit("hook",n),n.on("error",function(e){r.failHook(n,e)}),void n.run(function(s){n.removeAllListeners("error");var a=n.error();return a&&r.fail(r.test,a),s?(r.failHook(n,s),t(s)):(r.emit("hook end",n),delete n.ctx.currentTest,void i(++e))})):t()}var n=this.suite,s=n["_"+e],r=this;Runner.immediately(function(){i(0)})},Runner.prototype.hooks=function(e,t,i){function n(a){return s.suite=a,a?void s.hook(e,function(e){if(e){var a=s.suite;return s.suite=r,i(e,a)}n(t.pop())}):(s.suite=r,i())}var s=this,r=this.suite;n(t.pop())},Runner.prototype.hookUp=function(e,t){var i=[this.suite].concat(this.parents()).reverse();this.hooks(e,i,t)},Runner.prototype.hookDown=function(e,t){var i=[this.suite].concat(this.parents());this.hooks(e,i,t)},Runner.prototype.parents=function(){for(var e=this.suite,t=[];e=e.parent;)t.push(e);return t},Runner.prototype.runTest=function(e){var t=this.test,i=this;this.asyncOnly&&(t.asyncOnly=!0);try{t.on("error",function(e){i.fail(t,e)}),t.run(e)}catch(n){e(n)}},Runner.prototype.runTests=function(e,t){function i(e,n,s){var a=r.suite;r.suite=s?n.parent:n,r.suite?r.hookUp("afterEach",function(e,s){return r.suite=a,e?i(e,s,!0):void t(n)}):(r.suite=a,t(n))}function n(o,l){if(r.failures&&e._bail)return t();if(r._abort)return t();if(o)return i(o,l,!0);if(s=a.shift(),!s)return t();var u=r._grep.test(s.fullTitle());return r._invert&&(u=!u),u?s.pending?(r.emit("pending",s),r.emit("test end",s),n()):(r.emit("test",r.test=s),void r.hookDown("beforeEach",function(e,t){return e?i(e,t,!1):(r.currentRunnable=r.test,void r.runTest(function(e){return s=r.test,e?(r.fail(s,e),r.emit("test end",s),r.hookUp("afterEach",n)):(s.state="passed",r.emit("pass",s),r.emit("test end",s),void r.hookUp("afterEach",n))}))})):n()}var s,r=this,a=e.tests.slice();this.next=n,n()},Runner.prototype.runSuite=function(e,t){function i(t){if(t)return t==e?n():n(t);if(r._abort)return n();var s=e.suites[a++];return s?void r.runSuite(s,i):n()}function n(i){r.suite=e,r.hook("afterAll",function(){r.emit("suite end",e),t(i)})}var s=this.grepTotal(e),r=this,a=0;return debug("run suite %s",e.fullTitle()),s?(this.emit("suite",this.suite=e),void this.hook("beforeAll",function(t){return t?n():void r.runTests(e,i)})):t()},Runner.prototype.uncaught=function(e){e?debug("uncaught exception %s",e!==function(){return this}.call(e)?e:e.message||e):(debug("uncaught undefined exception"),e=utils.undefinedError()),e.uncaught=!0;var t=this.currentRunnable;if(t){var i=t.state;if(this.fail(t,e),t.clearTimeout(),!i)return"test"==t.type?(this.emit("test end",t),void this.hookUp("afterEach",this.next)):void this.emit("end")}},Runner.prototype.run=function(e){function t(e){i.uncaught(e)}var i=this,e=e||function(){};return debug("start"),this.on("end",function(){debug("end"),process.removeListener("uncaughtException",t),e(i.failures)}),this.emit("start"),this.runSuite(this.suite,function(){debug("finished running"),i.emit("end")}),process.on("uncaughtException",t),this},Runner.prototype.abort=function(){debug("aborting"),this._abort=!0};